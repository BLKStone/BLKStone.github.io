<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="关于计算机科学的学习经历与精彩文章分享。" />



  <meta name="keywords" content="信息检索,爬虫,python," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      google: ''
    },
    sidebar: 'post'
  };
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?351a523b2429a0dda1b90bb708a00fad";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <title> 一个简易搜索引擎(Python) // Neurohazard </title>
</head>

<body>
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Neurohazard</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<div class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/">
            <i class="menu-item-icon icon-home"></i> <br />
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            <i class="menu-item-icon icon-about"></i> <br />
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            <i class="menu-item-icon icon-archives"></i> <br />
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            <i class="menu-item-icon icon-tags"></i> <br />
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-friend">
          <a href="/friend">
            <i class="menu-item-icon icon-friend"></i> <br />
            友情鏈接
          </a>
        </li>
      
        
        <li class="menu-item menu-item-reading-list">
          <a href="/reading-list">
            <i class="menu-item-icon icon-reading-list"></i> <br />
            閱讀清單
          </a>
        </li>
      
    </ul>
  

  
</div>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              一个简易搜索引擎(Python)
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2015-12-06
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分類於
            
              <a href="/categories/Python/">Python</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/12/06/PySearchEngine/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/06/PySearchEngine/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <blockquote>
<p>本文代码参考 《集体智慧编程》第四章 搜索与排名</p>
</blockquote>
<h1 id="总体架构"><a href="#总体架构" class="headerlink" title="总体架构"></a>总体架构</h1><p><img src="http://7xke9x.com1.z0.glb.clouddn.com/2015-12/Architecture.png" alt="Alt text"></p>
<h1 id="Crawler爬虫模块"><a href="#Crawler爬虫模块" class="headerlink" title="Crawler爬虫模块"></a>Crawler爬虫模块</h1><h2 id="类设计"><a href="#类设计" class="headerlink" title="类设计"></a>类设计</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 初始化Crawler的类并传入数据库名称</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, dbname)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con = sqlite.connect(dbname)</div><div class="line">    <span class="keyword">self</span>.visited = BloomFilter(capacity=<span class="number">1000000</span>, error_rate=<span class="number">0</span>.<span class="number">001</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbcommit</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con.commit()</div></pre></td></tr></table></figure>
<h2 id="控制流程"><a href="#控制流程" class="headerlink" title="控制流程"></a>控制流程</h2><p>爬虫模块基本抓取方式按一下流程图工作，其工作原理近似于针对图遍历的广度优先搜索（Breadth First Search, BFS）。将所有要查询的页面放在一个pagelist(类型为list)中，在循环深度小于depth的情况下，如果此时pagelist中还有，从list中取出一个页面的url，对该页面进行解析和建立索引，之后将该页面中的所有超链接加入到newpage(类型为set,可以帮助去重)。在本轮pagelist遍历完成后，用newpage替代pagelist。</p>
<p>流程图<br><img src="http://7xke9x.com1.z0.glb.clouddn.com/2015-12/flowchart.png" alt="Alt text"></p>
<p>代码如下所示</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(<span class="keyword">self</span>, pages, depth=<span class="number">3</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(depth)<span class="symbol">:</span></div><div class="line">        newpages = set()</div><div class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> <span class="symbol">pages:</span></div><div class="line">            <span class="symbol">try:</span></div><div class="line">                c = urllib2.urlopen(page)</div><div class="line">            <span class="symbol">except:</span></div><div class="line">                print <span class="string">"Could not open %s"</span> % page</div><div class="line">                continue</div><div class="line"></div><div class="line">            html = c.read()</div><div class="line">            soup = BeautifulSoup(html)</div><div class="line"></div><div class="line">            <span class="keyword">self</span>.addtoindex(page, soup)</div><div class="line">            <span class="keyword">self</span>.visited.add(page)  <span class="comment"># 加入布隆过滤器</span></div><div class="line"></div><div class="line">            links = soup(<span class="string">'a'</span>)</div><div class="line"></div><div class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> <span class="symbol">links:</span></div><div class="line">                <span class="keyword">if</span> <span class="string">'href'</span> <span class="keyword">in</span> dict(link.attrs)<span class="symbol">:</span></div><div class="line">                    url = urljoin(page, link[<span class="string">'href'</span>])</div><div class="line">                    url = url.split(<span class="string">'&lt;'</span>)[<span class="number">0</span>]</div><div class="line">                    url = url.split(<span class="string">'#'</span>)[<span class="number">0</span>]</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> url[<span class="number">0</span><span class="symbol">:</span><span class="number">4</span>] == <span class="string">'http'</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">self</span>.isindexedbloom(url)<span class="symbol">:</span></div><div class="line">                        <span class="keyword">if</span> <span class="keyword">self</span>.urlfilter(url)<span class="symbol">:</span></div><div class="line">                            newpages.add(url)</div><div class="line">                            linktext = <span class="keyword">self</span>.drytext(link.text)</div><div class="line">                            <span class="keyword">self</span>.addlinkref(page, url, linktext)</div><div class="line"></div><div class="line">            <span class="keyword">self</span>.dbcommit()</div><div class="line">        pages = newpages</div></pre></td></tr></table></figure>
<h2 id="页面抽取"><a href="#页面抽取" class="headerlink" title="页面抽取"></a>页面抽取</h2><p>该部分的主要工作是，获取HTML并解析，之后在数据库建立索引。</p>
<p>页面内容获取主要使用urllib2，发出HTTP请求，从服务器获取相应的HTML。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">try:</div><div class="line">    c = urllib2.urlopen(page)</div><div class="line">except:</div><div class="line">    <span class="builtin-name">print</span> <span class="string">"Could not open %s"</span> % page</div><div class="line">    continue</div><div class="line">html = c.read()</div></pre></td></tr></table></figure></p>
<p>再用BeautifulSoup 4解析HTML。<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">soup</span> = BeautifulSoup(html)</div></pre></td></tr></table></figure></p>
<p>在数据库中建立索引，其中的细节下一阶段再详述。<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self.addtoindex(page, </span>soup)</div></pre></td></tr></table></figure></p>
<p>为了过滤重复的URL，这里引入了布隆过滤器，所有访问过的url都会加入布隆过滤器中。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self<span class="selector-class">.visited</span><span class="selector-class">.add</span>(page)</div></pre></td></tr></table></figure></p>
<p>页面抽取过程中,需要将HTML转换成纯文本，HTML中的&lt; script &gt;标签中的JavaScript和&lt; style &gt;定义的CSS样式表是没必要在建立索引时考虑的。另外过多的空格也会引起分词模块的误判,因此引入gettextonly函数进行预处理。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">def gettextonly(soup):</div><div class="line"></div><div class="line">    # 清理script标签和<span class="built_in">style</span>标签之间的内容</div><div class="line">    [script.extract() <span class="keyword">for</span> script <span class="keyword">in</span> soup.findAll('script')]</div><div class="line">    [<span class="built_in">style</span>.extract() <span class="keyword">for</span> <span class="built_in">style</span> <span class="keyword">in</span> soup.findAll('<span class="built_in">style</span>')]</div><div class="line">    </div><div class="line">    # 清理标签('&lt;'与'&gt;'之间包裹的所有内容)</div><div class="line">    reg = re.<span class="built_in">compile</span>(<span class="string">"&lt;[^&gt;]*&gt;"</span>)</div><div class="line">    <span class="built_in">content</span> = reg.sub('', soup.prettify()).strip()</div><div class="line">    </div><div class="line">    # 清除过多空格 若干个空格=&gt;一个空格</div><div class="line">    <span class="built_in">content</span> = <span class="string">" "</span>.<span class="built_in">join</span>(<span class="built_in">content</span>.<span class="built_in">split</span>())</div><div class="line"></div><div class="line">    <span class="built_in">return</span> <span class="built_in">content</span></div></pre></td></tr></table></figure>
<h2 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h2><p>在讨论索引建立之前，先说明一下数据库设计，如下图所示。</p>
<p><img src="http://7xke9x.com1.z0.glb.clouddn.com/2015-12/SearchindexDB.png" alt="Alt text"></p>
<p>建立数据库的语句</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"># 创建数据库表</div><div class="line">def createindextables(self):</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create table urllist(url)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create table wordlist(word)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create table wordlocation(urlid,wordid,location)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create table link(fromid integer,toid integer)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create table linkwords(wordid,linkid)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create index wordidx on wordlist(word)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create index urlidx on urllist(url)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create index wordurlidx on wordlocation(wordid)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create index urltoidn on link(toid)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'create index urlfromidx on link(fromid)'</span>)</div><div class="line">    self.<span class="keyword">con</span>.commit()</div></pre></td></tr></table></figure>
<p>建立索引的过程就是在数据库的urllist表中加入url记录，在wordlist表中加入word记录，以及在wordlocation中加入新的记录，这样我们就记住了某个单词在某个页面的某个位置的信息，用于Searcher模块的查询。</p>
<p>这个部分最重要的逻辑就是执行一下语句<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">insert into wordlocation(urlid,wordid,location) values (<span class="number">1</span>,<span class="number">4</span>,<span class="number">0</span>)</div><div class="line">insert into wordlocation(urlid,wordid,location) values (<span class="number">1</span>,<span class="number">8</span>,<span class="number">1</span>)</div><div class="line">insert into wordlocation(urlid,wordid,location) values (<span class="number">1</span>,<span class="number">15</span>,<span class="number">2</span>)</div><div class="line">....</div><div class="line">insert into wordlocation(urlid,wordid,location) values (<span class="number">1</span>,<span class="number">1124</span>,<span class="number">503</span>)</div></pre></td></tr></table></figure></p>
<p>代码<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 为每个网页建立索引</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">addtoindex</span><span class="params">(<span class="keyword">self</span>, url, soup)</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.isindexed(url)<span class="symbol">:</span></div><div class="line">        <span class="keyword">return</span></div><div class="line">        </div><div class="line">    print <span class="string">'Indexing %s'</span> % url</div><div class="line"></div><div class="line">    <span class="comment"># 获取经过预处理的HTML文本</span></div><div class="line">    text = <span class="keyword">self</span>.gettextonly(soup)</div><div class="line">    <span class="comment"># 分词</span></div><div class="line">    words = <span class="keyword">self</span>.separatewords(text)</div><div class="line"></div><div class="line">    <span class="comment"># 得到URL的id</span></div><div class="line">    urlid = <span class="keyword">self</span>.getentryid(<span class="string">'urllist'</span>, <span class="string">'url'</span>, url)</div><div class="line"></div><div class="line">    <span class="comment"># 将每个单词与该url关联</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(words))<span class="symbol">:</span></div><div class="line">        word = words[i]</div><div class="line">        <span class="keyword">if</span> word <span class="keyword">in</span> <span class="symbol">ignorewords:</span></div><div class="line">            continue</div><div class="line">        wordid = <span class="keyword">self</span>.getentryid(<span class="string">'wordlist'</span>, <span class="string">'word'</span>, word)</div><div class="line">        <span class="keyword">self</span>.con.execute(<span class="string">"insert into wordlocation(urlid,wordid,location) \</span></div><div class="line"><span class="string">            values (%d,%d,%d)"</span> % (urlid, wordid, i))</div></pre></td></tr></table></figure></p>
<p>上文的getentryid的逻辑是，如果表中有该记录则返回该记录的id，如果没有该记录，则在表中插入一条记录，并返回插入的记录的id。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># 辅助函数，用于获取条目的id，并且如果条目不存在，就将其加入数据库中</div><div class="line">def getentryid(self, table, field, value, createnew=True):</div><div class="line"></div><div class="line">    cur = self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="comment">"select rowid from \</span></div><div class="line">        %s where %s=<span class="string">'%s'</span><span class="comment">" % (table, field, value))</span></div><div class="line">    <span class="keyword">res</span> = cur.fetchone()</div><div class="line"></div><div class="line">    # 如果条目不存在，就加入一条新数据</div><div class="line">    <span class="keyword">if</span> <span class="keyword">res</span> <span class="keyword">is</span> None:</div><div class="line">        cur = self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="comment">"insert into %s \</span></div><div class="line">            (%s) <span class="built_in">values</span> (<span class="string">'%s'</span>)<span class="comment">" % (table, field, value))</span></div><div class="line">        <span class="keyword">return</span> cur.lastrowid</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">return</span> <span class="keyword">res</span>[<span class="number">0</span>]</div></pre></td></tr></table></figure></p>
<p>中文分词部分使用的是现成的模块叫做<a href="https://github.com/fxsjy/jieba" target="_blank" rel="external">结巴分词</a>(Jieba)，具体采用的算法根据文档应该是TF-IDF算法和TextRank算法，当然这部分我并没有深究太多。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">def separatewords(self, <span class="built_in">text</span>):</div><div class="line">    seg_list = jieba.cut_for_search(<span class="built_in">text</span>)</div><div class="line">    <span class="literal">result</span> = []</div><div class="line">    <span class="keyword">for</span> seg <span class="keyword">in</span> seg_list:</div><div class="line">        <span class="keyword">if</span> seg <span class="keyword">in</span> ignorewords:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="literal">result</span>.append(seg)</div><div class="line"><span class="built_in">    return</span> <span class="literal">result</span></div></pre></td></tr></table></figure>
<p>关于分词还有一点要说明，在汉语中，“的”、“是”之类的词，最好不要加入到wordlist中，这些词并没有什么实际含义，却会严重影响数据库检索效率。<br>所以addtoindex</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">ignorewords = set([<span class="string">'the'</span>, <span class="string">'of'</span>, <span class="string">'to'</span>, <span class="string">'and'</span>, <span class="string">'a'</span>, <span class="string">'in'</span>, <span class="string">'is'</span>, <span class="string">'it'</span>, <span class="string">'-'</span>, <span class="string">'，'</span>, <span class="string">'。'</span>, <span class="string">"'"</span>, <span class="string">''</span>, <span class="string">u'的'</span>, <span class="string">u'是'</span>])</div><div class="line"></div><div class="line"><span class="comment"># 将每个单词与该url关联</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(words)):</div><div class="line">    word = words[i]</div><div class="line">    <span class="keyword">if</span> word <span class="keyword">in</span> ignorewords:</div><div class="line">        <span class="keyword">continue</span></div><div class="line">    wordid = self.getentryid(<span class="string">'wordlist'</span>, <span class="string">'word'</span>, word)</div><div class="line">    self.con.execute(<span class="string">"insert into wordlocation(urlid,wordid,location) \</span></div><div class="line"><span class="string">        values (%d,%d,%d)"</span> % (urlid, wordid, i))</div></pre></td></tr></table></figure>
<h2 id="URL过滤"><a href="#URL过滤" class="headerlink" title="URL过滤"></a>URL过滤</h2><p>因为我只想抓豆瓣电影Top250的内容，所以对URL进行了过滤。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> url[<span class="number">0</span><span class="symbol">:</span><span class="number">4</span>] == <span class="string">'http'</span> <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">self</span>.isindexedbloom(url)<span class="symbol">:</span></div><div class="line">                        <span class="keyword">if</span> <span class="keyword">self</span>.urlfilter(url)<span class="symbol">:</span></div><div class="line">                            newpages.add(url)</div><div class="line">                            linktext = <span class="keyword">self</span>.drytext(link.text)</div><div class="line">                            <span class="keyword">self</span>.addlinkref(page, url, linktext)</div></pre></td></tr></table></figure>
<p>判断url是否曾经加入过布隆过滤器<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">isindexedbloom</span><span class="params">(<span class="keyword">self</span>, url)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">return</span> url <span class="keyword">in</span> <span class="keyword">self</span>.visited</div></pre></td></tr></table></figure></p>
<p>利用正则表达式过滤URL地址<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">urlfilter</span><span class="params">(self, url)</span>:</span></div><div class="line">    matcher_1 = re.compile(<span class="string">r'http://movie.douban.com/top250\?start=\d+.*'</span>)</div><div class="line">    matcher_2 = re.compile(<span class="string">r'^http://movie.douban.com/subject/\d+/$'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (matcher_1.match(url) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">or</span></div><div class="line">                matcher_2.match(url) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>):</div><div class="line">        <span class="keyword">return</span> <span class="keyword">True</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">False</span></div></pre></td></tr></table></figure></p>
<p>这里还补充了一部分建立索引的过程。在link表中，我们描述了页面之间相互指向的关系。另外，超链接的说明文字通常也有很高的参考价值，所以我们要把它存到linkword表中。</p>
<p>关键SQL<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">link</span> (fromid,toid) <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">link</span> (fromid,toid) <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">3</span>)</div><div class="line">......</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">link</span> (fromid,toid) <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">17</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> linkword (wordid,linkid) <span class="keyword">values</span> (<span class="number">32</span>,<span class="number">1</span>)</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> linkword (wordid,linkid) <span class="keyword">values</span> (<span class="number">413</span>,<span class="number">1</span>)</div><div class="line">......</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> linkword (wordid,linkid) <span class="keyword">values</span> (<span class="number">86</span>,<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>代码<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加一个关联两个网页的链接,记录描述超链接的关键词</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">addlinkref</span><span class="params">(<span class="keyword">self</span>, urlFrom, urlTo, linkText)</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    fromid = <span class="keyword">self</span>.getentryid(<span class="string">'urllist'</span>, <span class="string">'url'</span>, urlFrom)</div><div class="line">    toid = <span class="keyword">self</span>.getentryid(<span class="string">'urllist'</span>, <span class="string">'url'</span>, urlTo)</div><div class="line"></div><div class="line">    cur = <span class="keyword">self</span>.con.execute(<span class="string">"insert into link\</span></div><div class="line"><span class="string">        (fromid,toid) values (%d,%d)"</span> % (fromid, toid))</div><div class="line"></div><div class="line">    linkid = cur.lastrowid</div><div class="line"></div><div class="line">    <span class="comment"># 如果超链接的描述text为空的话就不添加记录</span></div><div class="line">    <span class="comment"># 若不为空，先分词，再向linkword表添加记录</span></div><div class="line">    <span class="keyword">if</span> linkText != <span class="string">''</span><span class="symbol">:</span></div><div class="line">        <span class="comment"># 拆分单词</span></div><div class="line">        words = <span class="keyword">self</span>.separatewords(linkText)</div><div class="line"></div><div class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> <span class="symbol">words:</span></div><div class="line">            wordid = <span class="keyword">self</span>.getentryid(<span class="string">'wordlist'</span>, <span class="string">'word'</span>, word)</div><div class="line">            <span class="keyword">self</span>.con.execute(<span class="string">"insert into linkwords\</span></div><div class="line"><span class="string">                (wordid,linkid) values (%d,%d)"</span> % (wordid, linkid))</div><div class="line">    <span class="keyword">return</span></div></pre></td></tr></table></figure></p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import PySearchEngine</div><div class="line">crawler = PySearchEngine.Crawler('searchindex.db')</div><div class="line">crawler.createindextables()</div><div class="line">pages = ['http://movie.douban.com/top250']</div><div class="line">crawler.crawl(pages)</div></pre></td></tr></table></figure>
<h1 id="Searcher搜索模块"><a href="#Searcher搜索模块" class="headerlink" title="Searcher搜索模块"></a>Searcher搜索模块</h1><h2 id="类设计-1"><a href="#类设计-1" class="headerlink" title="类设计"></a>类设计</h2><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 初始化Searcher的类并传入数据库名称</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, dbname)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con = sqlite.connect(dbname)</div><div class="line">    <span class="keyword">self</span>.debug_mode = False</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con.close()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">changedebugmode</span><span class="params">(<span class="keyword">self</span>, switch)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.debug_mode = switch</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">dbcommit</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con.commit()</div></pre></td></tr></table></figure>
<h2 id="查询相关URL"><a href="#查询相关URL" class="headerlink" title="查询相关URL"></a>查询相关URL</h2><p>将输入的查询分词，构造查询SQL语句，返回结果。<br>如果单词不在wordlist中则忽略该单词。</p>
<p>构造的SQL如下，假设查询可分为5个有效单词<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">select w0.urlid,w0.location,w1.location,w2.location,w3.location,w4.location </div><div class="line"><span class="keyword">from</span> wordlocation w0,wordlocation w1,wordlocation w2,wordlocation w3,wordlocation w4 </div><div class="line">where w0.<span class="attribute">wordid</span>=609 <span class="keyword">and</span> w0.<span class="attribute">urlid</span>=w1.urlid </div><div class="line"><span class="keyword">and</span> w1.<span class="attribute">wordid</span>=331 <span class="keyword">and</span> w1.<span class="attribute">urlid</span>=w2.urlid </div><div class="line"><span class="keyword">and</span> w2.<span class="attribute">wordid</span>=144 <span class="keyword">and</span> w2.<span class="attribute">urlid</span>=w3.urlid </div><div class="line"><span class="keyword">and</span> w3.<span class="attribute">wordid</span>=67 <span class="keyword">and</span> w3.<span class="attribute">urlid</span>=w4.urlid</div><div class="line"><span class="keyword">and</span> w4.<span class="attribute">wordid</span>=145</div></pre></td></tr></table></figure></p>
<p>代码<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">def getmatchrows(self, q):</div><div class="line"></div><div class="line">    <span class="comment"># 构造查询的字符串的基本元素</span></div><div class="line">    fieldlist = <span class="string">'w0.urlid'</span></div><div class="line">    tablelist = <span class="string">''</span></div><div class="line">    clauselist = <span class="string">''</span></div><div class="line">    wordids = []</div><div class="line"></div><div class="line">    <span class="comment"># 拆分查询query单词</span></div><div class="line">    <span class="keyword">words</span> = self.separatewords(q)</div><div class="line"></div><div class="line">    <span class="comment"># 删除停词</span></div><div class="line">    <span class="keyword">for</span> <span class="built_in">word</span> <span class="keyword">in</span> <span class="keyword">words</span>:</div><div class="line">        <span class="keyword">if</span> <span class="built_in">word</span> <span class="keyword">in</span> ignorewords:</div><div class="line">            <span class="keyword">words</span>.remove(<span class="built_in">word</span>)</div><div class="line">    </div><div class="line">    <span class="comment"># 统计是几张表联合查询</span></div><div class="line">    tablenumber = <span class="number">0</span></div><div class="line">    </div><div class="line">    <span class="keyword">for</span> <span class="built_in">word</span> <span class="keyword">in</span> <span class="keyword">words</span>:</div><div class="line">        <span class="comment"># 获取单词的ID，如果单词不在wordlist中则忽略</span></div><div class="line">        wordrow = self.con.execute(</div><div class="line">            <span class="string">"select rowid from wordlist where word='%s'"</span> % <span class="built_in">word</span>).fetchone()</div><div class="line"></div><div class="line">        <span class="keyword">if</span> wordrow is <span class="keyword">not</span> None:</div><div class="line">            wordid = wordrow[<span class="number">0</span>]</div><div class="line">            wordids.append(wordid)</div><div class="line">            <span class="keyword">if</span> tablenumber &gt; <span class="number">0</span>:</div><div class="line">                tablelist += <span class="string">','</span></div><div class="line">                clauselist += <span class="string">' and '</span></div><div class="line">                clauselist += <span class="string">'w%d.urlid=w%d.urlid and '</span> % (tablenumber - <span class="number">1</span>, tablenumber)</div><div class="line"></div><div class="line">            fieldlist += <span class="string">',w%d.location'</span> % tablenumber</div><div class="line">            tablelist += <span class="string">'wordlocation w%d'</span> % tablenumber</div><div class="line">            clauselist += <span class="string">'w%d.wordid=%d'</span> % (tablenumber, wordid)</div><div class="line">            tablenumber += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="comment"># 根据各个分组，建立查询</span></div><div class="line">    fullquery = <span class="string">'select %s from %s where %s'</span> % (fieldlist, tablelist, clauselist)</div><div class="line">    cur = self.con.execute(fullquery)</div><div class="line">    rows = [row <span class="keyword">for</span> row <span class="keyword">in</span> cur]</div><div class="line">    <span class="literal">return</span> rows, wordids</div></pre></td></tr></table></figure></p>
<h2 id="查询接口"><a href="#查询接口" class="headerlink" title="查询接口"></a>查询接口</h2><p>查询到的相关网页集合，其形式为<code>(urlid,w0.location,w1.location,w2.location)</code><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(<span class="keyword">self</span>, q)</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    <span class="comment"># rows 查询到的相关网页集合 </span></div><div class="line">    rows, wordids = <span class="keyword">self</span>.getmatchrows(q)</div><div class="line"></div><div class="line">    <span class="comment"># 计算url总分</span></div><div class="line">    scores = <span class="keyword">self</span>.getscorelist(rows, wordids)</div><div class="line">    <span class="comment"># 排序展示</span></div><div class="line">    rankedscores = sorted([(score, url) <span class="keyword">for</span> (url, score) <span class="keyword">in</span> scores.items()], reverse=<span class="number">1</span>)</div><div class="line">    <span class="keyword">for</span> i, (score, urlid) <span class="keyword">in</span> enumerate(rankedscores[<span class="number">0</span><span class="symbol">:</span><span class="number">10</span>])<span class="symbol">:</span></div><div class="line">        print <span class="string">'%d %f\t%s'</span> % (i, score, <span class="keyword">self</span>.geturlname(urlid))</div></pre></td></tr></table></figure></p>
<h2 id="多指标排序"><a href="#多指标排序" class="headerlink" title="多指标排序"></a>多指标排序</h2><p>到目前为止，我们已经成功获得了与查询条件相匹配的网页。不过，其返回结果的排列顺序却很简单，即其被检索时的顺序。而面对大量的网页，我们该如何判断哪些URL对用户价值比较高，哪些URL对用户价值比较低呢（也就是给URL排序的问题）</p>
<p>这里我们综合考虑三种情况：</p>
<ul>
<li>基于内容排名</li>
<li>利用外部回指链接</li>
<li>跟踪点击的人工神经网络</li>
</ul>
<p>当然这三种情况还可以进一步细分，详细的指标之后详述。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getscorelist</span><span class="params">(<span class="keyword">self</span>, rows, wordids)</span></span><span class="symbol">:</span></div><div class="line">    totalscores = dict([(row[<span class="number">0</span>], <span class="number">0</span>) <span class="keyword">for</span> row <span class="keyword">in</span> rows])</div><div class="line"></div><div class="line">    <span class="comment"># 各类评价函数</span></div><div class="line">    weights = [(<span class="number">1.0</span>, <span class="keyword">self</span>.frequencyscore(rows)),</div><div class="line">               (<span class="number">1.0</span>, <span class="keyword">self</span>.locationscore(rows)),</div><div class="line">               (<span class="number">1.0</span>, <span class="keyword">self</span>.distancescore(rows)),</div><div class="line">               (<span class="number">1.0</span>, <span class="keyword">self</span>.inboundlinkscore(rows)),</div><div class="line">               (<span class="number">1.0</span>, <span class="keyword">self</span>.linktextscore(rows, wordids)),</div><div class="line">               (<span class="number">1.0</span>, <span class="keyword">self</span>.nnscore(rows,wordids))]</div><div class="line">    </div><div class="line">    <span class="comment"># 加权计算总分</span></div><div class="line">    <span class="keyword">for</span> (weight, scores) <span class="keyword">in</span> <span class="symbol">weights:</span></div><div class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> <span class="symbol">totalscores:</span></div><div class="line">            totalscores[url] += weight * scores[url]</div><div class="line"></div><div class="line">    <span class="keyword">return</span> totalscores</div></pre></td></tr></table></figure>
<h2 id="归一化函数"><a href="#归一化函数" class="headerlink" title="归一化函数"></a>归一化函数</h2><p>在详细说明各种评价指标之前，先说明一个公用的辅助函数――归一化函数。这个函数的功能是接收一个包含urlid和评价分数score的字典，并返回一个带有相同urlid，而评价分数score介于0和1之间的新字典。</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta"># 归一化函数</span></div><div class="line">def normalizescore(self, scores, smallIsBetter = <span class="number">0</span>):</div><div class="line">    vsmall = <span class="number">0.0001</span>  <span class="meta"># 避免被0整除</span></div><div class="line">    <span class="keyword">if</span> smallIsBetter:</div><div class="line">        minscore = <span class="built_in">min</span>(scores.values())</div><div class="line">        <span class="keyword">return</span> dict([(u, <span class="type">float</span>(minscore) / <span class="built_in">max</span>(vsmall, l)) <span class="keyword">for</span> (u, l) \</div><div class="line">                     <span class="keyword">in</span> scores.items()])</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        maxscore = <span class="built_in">max</span>(scores.values())</div><div class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(maxscore - <span class="number">0</span>) &lt; <span class="number">1e-4</span>:</div><div class="line">            maxscore = vsmall</div><div class="line"></div><div class="line">        <span class="keyword">return</span> dict([(u, <span class="type">float</span>(c) / maxscore) <span class="keyword">for</span> (u, c) <span class="keyword">in</span> scores.items()])</div></pre></td></tr></table></figure>
<h2 id="基于内容的排名"><a href="#基于内容的排名" class="headerlink" title="基于内容的排名"></a>基于内容的排名</h2><p>###单词频度</p>
<p>单词频度的基本思想是：位于查询条件中的单词在文档中出现的次数能有助于我们判断文档的相关程度。<strong>位于查询条件中的单词在文档中出现的次数越多，这篇文档的价值越高.</strong></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 单词频度 Word Frequency</span></div><div class="line"><span class="comment"># rows 查询到的相关网页集合 (urlid,w0.location,w1.location,w2.location)</span></div><div class="line"><span class="comment"># counts 记录的是</span></div><div class="line"><span class="comment"># w0 出现的词频 + w1 出现的词频 + .... wN 出现的词频</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">frequencyscore</span><span class="params">(<span class="keyword">self</span>, rows)</span></span><span class="symbol">:</span></div><div class="line">    counts = dict([(row[<span class="number">0</span>], <span class="number">0</span>) <span class="keyword">for</span> row <span class="keyword">in</span> rows])</div><div class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> <span class="symbol">rows:</span></div><div class="line">        counts[row[<span class="number">0</span>]] += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.normalizescore(counts)</div></pre></td></tr></table></figure>
<p>###文档位置</p>
<p>文档位置的基本思想是：位于查询条件中的单词在文档中出现在靠近文档开始处的时候，它很有可能是文档的主题。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 文档位置</span></div><div class="line"><span class="comment"># 记录所有关键词的位置索引的和loc</span></div><div class="line"><span class="comment"># loc越小认为相关性越强</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">locationscore</span><span class="params">(<span class="keyword">self</span>, rows)</span></span><span class="symbol">:</span></div><div class="line">    locations = dict([(row[<span class="number">0</span>], <span class="number">10000000</span>) <span class="keyword">for</span> row <span class="keyword">in</span> rows])</div><div class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> <span class="symbol">rows:</span></div><div class="line">        loc = sum(row[<span class="number">1</span><span class="symbol">:</span>])</div><div class="line">        <span class="keyword">if</span> loc &lt; locations[row[<span class="number">0</span>]]: locations[row[<span class="number">0</span>]] = loc</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.normalizescore(locations, smallIsBetter=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>###单词距离</p>
<p>单词距离的基本思想是：如果查询条件中有多个单词，则它们在文档中出现的位置越近越好。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 单词距离</div><div class="line"># 词与词之间的位置差的绝对值的和</div><div class="line"># 越小越好</div><div class="line">def distancescore(self, rows):</div><div class="line"></div><div class="line">    # 如果仅有一个单词，则得分都一样</div><div class="line">    <span class="keyword">if</span> len(rows[<span class="number">0</span>]) &lt;= <span class="number">2</span>: <span class="built_in">return</span> dict([(<span class="built_in">row</span>[<span class="number">0</span>], <span class="number">1.0</span>) <span class="keyword">for</span> <span class="built_in">row</span> <span class="keyword">in</span> rows])</div><div class="line"></div><div class="line">    # 初始化字典</div><div class="line">    mindistance = dict([(<span class="built_in">row</span>[<span class="number">0</span>], <span class="number">10000000</span>) <span class="keyword">for</span> <span class="built_in">row</span> <span class="keyword">in</span> rows])</div><div class="line"></div><div class="line">    <span class="keyword">for</span> <span class="built_in">row</span> <span class="keyword">in</span> rows:</div><div class="line">        dist = <span class="built_in">sum</span>(<span class="built_in">abs</span>(<span class="built_in">row</span>[i] - <span class="built_in">row</span>[i - <span class="number">1</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, len(<span class="built_in">row</span>)))</div><div class="line">        <span class="keyword">if</span> dist &lt; mindistance[<span class="built_in">row</span>[<span class="number">0</span>]]: mindistance[<span class="built_in">row</span>[<span class="number">0</span>]] = dist</div><div class="line">    <span class="built_in">return</span> self.normalizescore(mindistance, smallIsBetter=<span class="number">1</span>)</div></pre></td></tr></table></figure>
<h2 id="利用外部回指链接"><a href="#利用外部回指链接" class="headerlink" title="利用外部回指链接"></a>利用外部回指链接</h2><h3 id="简单计数"><a href="#简单计数" class="headerlink" title="简单计数"></a>简单计数</h3><p>处理外部回指链接最为简单的做法，是在每个网页上统计链接的数目，并将链接总数作为针对网页的度量。科研论文的评价就经常采用这样的方式，人们将论文的重要程度与其他论文对该论文的引用次数联系了起来。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 简单统计指向该页面的连接数</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">inboundlinkscore</span><span class="params">(<span class="keyword">self</span>, rows)</span></span><span class="symbol">:</span></div><div class="line">    uniqueurls = set([row[<span class="number">0</span>] <span class="keyword">for</span> row <span class="keyword">in</span> rows])</div><div class="line">    inboundcount = dict([(u, <span class="keyword">self</span>.con.execute(</div><div class="line">        <span class="string">'select count(*) from link where toid=%d'</span> % u).fetchone()[<span class="number">0</span>]</div><div class="line">                          ) <span class="keyword">for</span> u <span class="keyword">in</span> uniqueurls])</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.normalizescore(inboundcount)</div></pre></td></tr></table></figure>
<h3 id="PageRank"><a href="#PageRank" class="headerlink" title="PageRank"></a>PageRank</h3><p>理论上，PageRank计算的是某个人在任意次链接点击后到达某一网页的可能性。如果某个网页拥有来自其他热门网页的外部回指链接越多，人们无意间到达该网页的可能性就会越大。当然，如果用户始终不停地点击，那么他们最终将到达每一个网页，但大多数人在浏览一段时间之后都会停止了点击。为了反映这一情况，PageRank还使用了一个值为0.85的<strong>阻尼因子</strong>，用以指示用户持续点击每个网页中链接的概率为85%。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculatepagerank</span><span class="params">(<span class="keyword">self</span>, iterations=<span class="number">20</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="comment"># 清除当前的 PageRank 表</span></div><div class="line">    <span class="keyword">self</span>.con.execute(<span class="string">'drop table if exists pagerank'</span>)</div><div class="line">    <span class="keyword">self</span>.con.execute(<span class="string">'create table pagerank(urlid primary key,score)'</span>)</div><div class="line"></div><div class="line">    <span class="comment"># 初始化每个url，令其PageRank值为1</span></div><div class="line">    <span class="keyword">self</span>.con.execute(<span class="string">'insert into pagerank select rowid, 1.0 from urllist'</span>)</div><div class="line">    <span class="keyword">self</span>.dbcommit()</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(iterations)<span class="symbol">:</span></div><div class="line">        print (<span class="string">"Iterations %d"</span> % i)</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (urlid,) <span class="keyword">in</span> <span class="keyword">self</span>.con.execute(<span class="string">'select rowid from urllist'</span>)<span class="symbol">:</span></div><div class="line"></div><div class="line">            <span class="comment"># 设置PageRank最小值</span></div><div class="line">            pr = <span class="number">0</span>.<span class="number">15</span></div><div class="line"></div><div class="line">            <span class="comment"># 循环遍历指向当前网页的所有其他网页</span></div><div class="line">            <span class="keyword">for</span> (linker,) <span class="keyword">in</span> <span class="keyword">self</span>.con.execute(<span class="string">'select distinct fromid  from link where toid=%d'</span> % urlid)<span class="symbol">:</span></div><div class="line">                <span class="comment"># 得到链接源对应网页的 PageRank值</span></div><div class="line">                linkingpr = <span class="keyword">self</span>.con.execute(</div><div class="line">                    <span class="string">"select score from pagerank where urlid=%d"</span> % linker).fetchone()[<span class="number">0</span>]</div><div class="line"></div><div class="line">                <span class="comment"># 根据链接源，求得总的链接数</span></div><div class="line">                linkingcount = <span class="keyword">self</span>.con.execute(</div><div class="line">                    <span class="string">"select count(*) from link where fromid=%d"</span> % linker).fetchone()[<span class="number">0</span>]</div><div class="line"></div><div class="line">                pr += <span class="number">0</span>.<span class="number">85</span> * (linkingpr / linkingcount)</div><div class="line"></div><div class="line">            <span class="comment"># 更新 PageRank值</span></div><div class="line">            <span class="keyword">self</span>.con.execute(</div><div class="line">                <span class="string">"update pagerank set score=%f where urlid=%d"</span> % (pr, urlid))</div><div class="line"></div><div class="line">        <span class="comment"># 每轮迭代结束commit一次</span></div><div class="line">        <span class="keyword">self</span>.dbcommit()</div></pre></td></tr></table></figure>
<h3 id="利用链接文本"><a href="#利用链接文本" class="headerlink" title="利用链接文本"></a>利用链接文本</h3><p>另一种对搜索结果进行排名的非常有效的方法，是根据指向某一网页的链接文本来决定网页的相关程度。大多数时候，相比与被链接的网页自身所提供的信息而言，我们从指向该网页的链接中(就是标签&lt; a &gt; 和 &lt; /a &gt; 之间包裹的内容)所得到的信息会更有价值。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 从链接文本中抽取有效信息</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">linktextscore</span><span class="params">(<span class="keyword">self</span>, rows, wordids)</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    linkscores = dict([(row[<span class="number">0</span>], <span class="number">0</span>) <span class="keyword">for</span> row <span class="keyword">in</span> rows])</div><div class="line">    <span class="keyword">for</span> wordid <span class="keyword">in</span> <span class="symbol">wordids:</span></div><div class="line">        cur = <span class="keyword">self</span>.con.execute(<span class="string">'select link.fromid,link.toid from\</span></div><div class="line"><span class="string">         linkwords,link where wordid=%d and linkwords.linkid=link.rowid\</span></div><div class="line"><span class="string">         '</span> % wordid)</div><div class="line"></div><div class="line">        <span class="comment"># 显然有时 cur 可能是 None</span></div><div class="line">        <span class="comment"># 如果无匹配的查询结果</span></div><div class="line">        <span class="keyword">if</span> cur is <span class="symbol">None:</span></div><div class="line">            <span class="keyword">return</span> linkscores</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (fromid, toid) <span class="keyword">in</span> <span class="symbol">cur:</span></div><div class="line">            <span class="keyword">if</span> toid <span class="keyword">in</span> <span class="symbol">linkscores:</span></div><div class="line">                pr = <span class="keyword">self</span>.con.execute(<span class="string">'select score from pagerank where urlid\</span></div><div class="line"><span class="string">                    =%d'</span> % fromid).fetchone()[<span class="number">0</span>]</div><div class="line">                linkscores[toid] += pr</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.normalizescore(linkscores)</div></pre></td></tr></table></figure>
<h2 id="跟踪点击的人工神经网络设计"><a href="#跟踪点击的人工神经网络设计" class="headerlink" title="跟踪点击的人工神经网络设计"></a>跟踪点击的人工神经网络设计</h2><p>跟踪点击率的神经网络单独成为一个模块 Searchnet 。</p>
<p>这个模块的效果是，<strong>对于同一个输入查询，用户对某个网页点击次数越多，该网页的得分就会越高</strong>。</p>
<p>如图所示，直接说明一下神经网络(准确的说是用反向传播算法训练的MLP)的设计，输入层是各种单词，隐含层是各种单词的组合，输出层则是对应文档URL，激活函数是反双曲正切变换函数(tanh)。</p>
<p><img src="http://7xke9x.com1.z0.glb.clouddn.com/2015-12/nn.png" alt="Alt text"></p>
<p>点击跟踪的神经网络设计</p>
<h3 id="类设计-2"><a href="#类设计-2" class="headerlink" title="类设计"></a>类设计</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Searchnet</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(<span class="keyword">self</span>, dbname)</span></span><span class="symbol">:</span></div><div class="line">        <span class="keyword">self</span>.con = sqlite.connect(dbname)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">        <span class="keyword">self</span>.con.close()</div></pre></td></tr></table></figure>
<h3 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">maketables</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.con.execute(<span class="string">'create table hiddennode(create_key)'</span>)</div><div class="line">    <span class="keyword">self</span>.con.execute(<span class="string">'create table wordhidden(fromid,toid,strength)'</span>)</div><div class="line">    <span class="keyword">self</span>.con.execute(<span class="string">'create table hiddenurl(fromid,toid,strength)'</span>)</div><div class="line">    <span class="keyword">self</span>.con.commit()</div></pre></td></tr></table></figure>
<h3 id="辅助函数"><a href="#辅助函数" class="headerlink" title="辅助函数"></a>辅助函数</h3><p>获取权值<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">def getstrength(self, fromid, toid, layer):</div><div class="line">    <span class="keyword">if</span> layer == <span class="number">0</span>:</div><div class="line">        table = <span class="string">'wordhidden'</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        table = <span class="string">'hiddenurl'</span></div><div class="line"></div><div class="line">    <span class="keyword">res</span> = self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'select strength from %s where fromid=%d\</span></div><div class="line"><span class="string">     and toid=%d'</span> % (table, fromid, toid)).fetchone()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">res</span> == None:</div><div class="line">        <span class="keyword">if</span> layer == <span class="number">0</span>: <span class="keyword">return</span> -<span class="number">0.2</span></div><div class="line">        <span class="keyword">if</span> layer == <span class="number">1</span>: <span class="keyword">return</span> <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">res</span>[<span class="number">0</span>]</div></pre></td></tr></table></figure></p>
<p>设置权值<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">def setstrength(self, fromid, toid, layer, strength):</div><div class="line"></div><div class="line">    <span class="keyword">if</span> layer == <span class="number">0</span>:</div><div class="line">        table = <span class="string">'wordhidden'</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        table = <span class="string">'hiddenurl'</span></div><div class="line"></div><div class="line">    <span class="keyword">res</span> = self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'select rowid from %s where fromid=%d \</span></div><div class="line"><span class="string">        and toid=%d'</span> % (table, fromid, toid)).fetchone()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">res</span> == None:</div><div class="line">        self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'insert into %s (fromid,toid,strength) \</span></div><div class="line"><span class="string">            values (%d,%d,%f)'</span> % (table, fromid, toid, strength))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        rowid = <span class="keyword">res</span>[<span class="number">0</span>]</div><div class="line">        self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="string">'update %s set strength=%f where \</span></div><div class="line"><span class="string">            rowid=%d'</span> % (table, strength, rowid))</div></pre></td></tr></table></figure></p>
<h3 id="建立新的隐含层节点"><a href="#建立新的隐含层节点" class="headerlink" title="建立新的隐含层节点"></a>建立新的隐含层节点</h3><p>此处有一个问题，我们只针对2个单词组合成的词建立了隐含层节点。<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">def generatehiddennode(self, wordids, urls):</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(wordids) &gt; <span class="number">3</span>: <span class="keyword">return</span> None</div><div class="line"></div><div class="line">    # 检查我们是否已经为这组单词建好了一个节点</div><div class="line">    createkey = <span class="string">'_'</span>.<span class="keyword">join</span>(sorted([str(<span class="keyword">wi</span>) <span class="keyword">for</span> <span class="keyword">wi</span> in wordids]))</div><div class="line">    <span class="keyword">res</span> = self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="comment">"select rowid from hiddennode \</span></div><div class="line">        where create_key=<span class="string">'%s'</span><span class="comment">" % createkey).fetchone()</span></div><div class="line"></div><div class="line">    # 如果没有，则建立之</div><div class="line">    <span class="keyword">if</span> <span class="keyword">res</span> == None:</div><div class="line">        cur = self.<span class="keyword">con</span>.<span class="keyword">execute</span>(<span class="comment">"insert into hiddennode (create_key)\</span></div><div class="line">            <span class="built_in">values</span> (<span class="string">'%s'</span>)<span class="comment">" % createkey)</span></div><div class="line">        hiddenid = cur.lastrowid</div><div class="line"></div><div class="line">        # 设置默认权重</div><div class="line">        <span class="keyword">for</span> wordid in wordid<span class="variable">s:</span></div><div class="line">            self.setstrength(wordid, hiddenid, <span class="number">0</span>, <span class="number">1.0</span> / <span class="built_in">len</span>(wordids))</div><div class="line">        <span class="keyword">for</span> urlid in url<span class="variable">s:</span></div><div class="line">            self.setstrength(hiddenid, urlid, <span class="number">1</span>, <span class="number">0.1</span>)</div><div class="line">        self.<span class="keyword">con</span>.commit()</div></pre></td></tr></table></figure></p>
<h3 id="查询相关隐层节点"><a href="#查询相关隐层节点" class="headerlink" title="查询相关隐层节点"></a>查询相关隐层节点</h3><p>在开始执行前馈算法之前，searchnet类的代码必须先从数据库中查询出节点与连接的信息，然后在内存中建立起与某项查询相关的所有节点。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 获取所有与检索结果相关的隐含层id</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getallhiddenids</span><span class="params">(<span class="keyword">self</span>, wordids, urlids)</span></span><span class="symbol">:</span></div><div class="line">    l1 = &#123;&#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> wordid <span class="keyword">in</span> <span class="symbol">wordids:</span></div><div class="line">        cur = <span class="keyword">self</span>.con.execute(<span class="string">'select toid from wordhidden where fromid=%d'</span> %</div><div class="line">                                wordid)</div><div class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> <span class="symbol">cur:</span></div><div class="line">            l1[row[<span class="number">0</span>]] = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> urlid <span class="keyword">in</span> <span class="symbol">urlids:</span></div><div class="line">        cur = <span class="keyword">self</span>.con.execute(<span class="string">'select fromid from hiddenurl where toid=%d'</span> %</div><div class="line">                               urlid)</div><div class="line"></div><div class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> <span class="symbol">cur:</span></div><div class="line">            l1[row[<span class="number">0</span>]] = <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> l1.keys()</div></pre></td></tr></table></figure>
<h3 id="设置网络初始权值"><a href="#设置网络初始权值" class="headerlink" title="设置网络初始权值"></a>设置网络初始权值</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 建立网络</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">setupnetwork</span><span class="params">(<span class="keyword">self</span>, wordids, urlids)</span></span><span class="symbol">:</span></div><div class="line">    <span class="comment"># 值列表</span></div><div class="line">    <span class="keyword">self</span>.wordids = wordids </div><div class="line">    <span class="keyword">self</span>.hiddenids = <span class="keyword">self</span>.getallhiddenids(wordids, urlids)</div><div class="line">    <span class="keyword">self</span>.urlids = urlids</div><div class="line"></div><div class="line">    <span class="comment"># 节点输出</span></div><div class="line">    <span class="keyword">self</span>.ai = [<span class="number">1.0</span>] * len(<span class="keyword">self</span>.wordids)</div><div class="line">    <span class="keyword">self</span>.ah = [<span class="number">1.0</span>] * len(<span class="keyword">self</span>.hiddenids)</div><div class="line">    <span class="keyword">self</span>.ao = [<span class="number">1.0</span>] * len(<span class="keyword">self</span>.urlids)</div><div class="line"></div><div class="line">    <span class="comment"># 建立权重矩阵</span></div><div class="line">    <span class="keyword">self</span>.wi = [[<span class="keyword">self</span>.getstrength(wordid,hiddenid,<span class="number">0</span>)</div><div class="line">                <span class="keyword">for</span> hiddenid <span class="keyword">in</span> <span class="keyword">self</span>.hiddenids]</div><div class="line">                <span class="keyword">for</span> wordid <span class="keyword">in</span> <span class="keyword">self</span>.wordids]</div><div class="line">    <span class="keyword">self</span>.wo = [[<span class="keyword">self</span>.getstrength(hiddenid,urlid,<span class="number">1</span>)</div><div class="line">                <span class="keyword">for</span> urlid <span class="keyword">in</span> <span class="keyword">self</span>.urlids]</div><div class="line">                <span class="keyword">for</span> hiddenid <span class="keyword">in</span> <span class="keyword">self</span>.hiddenids]</div></pre></td></tr></table></figure>
<h3 id="前向传播"><a href="#前向传播" class="headerlink" title="前向传播"></a>前向传播</h3><p>神经网络的计算过程<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 前向传播</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">feedforward</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    <span class="comment"># 查询单词是仅有的输入</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(<span class="keyword">self</span>.wordids))<span class="symbol">:</span></div><div class="line">        <span class="keyword">self</span>.ai[i] = <span class="number">1.0</span></div><div class="line"></div><div class="line">    <span class="comment"># 隐藏层节点的活跃程度</span></div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">        sum = <span class="number">0</span>.<span class="number">0</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(<span class="keyword">self</span>.wordids))<span class="symbol">:</span></div><div class="line">            sum = sum + <span class="keyword">self</span>.ai[i] * <span class="keyword">self</span>.wi[i][j]</div><div class="line">        <span class="keyword">self</span>.ah[j] = tanh(sum)</div><div class="line"></div><div class="line">    <span class="comment"># 输出层节点的活跃程度</span></div><div class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(len(<span class="keyword">self</span>.urlids))<span class="symbol">:</span></div><div class="line">        sum = <span class="number">0</span>.<span class="number">0</span></div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">            sum = sum + <span class="keyword">self</span>.ah[j] * <span class="keyword">self</span>.wo[j][k]</div><div class="line">        <span class="keyword">self</span>.ao[k] = tanh(sum)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.ao[<span class="symbol">:</span>]</div></pre></td></tr></table></figure></p>
<p>输出结果<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 计算神经网络输出结果</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getresult</span><span class="params">(<span class="keyword">self</span>,wordids,urlids)</span></span><span class="symbol">:</span></div><div class="line">    <span class="keyword">self</span>.setupnetwork(wordids, urlids)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.feedforward()</div></pre></td></tr></table></figure></p>
<h3 id="反向传播-backpropagate-训练"><a href="#反向传播-backpropagate-训练" class="headerlink" title="反向传播(backpropagate)训练"></a>反向传播(backpropagate)训练</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 反向传播算法</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">backpropagate</span><span class="params">(<span class="keyword">self</span>, targets, N = <span class="number">0</span>.<span class="number">5</span> )</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    <span class="comment"># 计算输出层误差</span></div><div class="line">    output_deltas = [<span class="number">0</span>.<span class="number">0</span>] * len(<span class="keyword">self</span>.urlids)</div><div class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(len(<span class="keyword">self</span>.urlids))<span class="symbol">:</span></div><div class="line">        error = targets[k] - <span class="keyword">self</span>.ao[k]</div><div class="line">        output_deltas[k] = dtanh(<span class="keyword">self</span>.ao[k]) * error</div><div class="line"></div><div class="line">    <span class="comment"># 计算隐藏层误差</span></div><div class="line">    hidden_deltas = [<span class="number">0</span>.<span class="number">0</span>] * len(<span class="keyword">self</span>.hiddenids)</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">        error = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(len(<span class="keyword">self</span>.urlids))<span class="symbol">:</span></div><div class="line">            error = error + output_deltas[k] * <span class="keyword">self</span>.wo[j][k]</div><div class="line">        hidden_deltas[j] = dtanh(<span class="keyword">self</span>.ah[j]) * error</div><div class="line"></div><div class="line">    <span class="comment"># 更新输出权重</span></div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(len(<span class="keyword">self</span>.urlids))<span class="symbol">:</span></div><div class="line">            change = output_deltas[k] * <span class="keyword">self</span>.ah[j]</div><div class="line">            <span class="keyword">self</span>.wo[j][k] = <span class="keyword">self</span>.wo[j][k] + N*change</div><div class="line"></div><div class="line">    <span class="comment"># 更新输入权重</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(<span class="keyword">self</span>.wordids))<span class="symbol">:</span></div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">            change = hidden_deltas[j] * <span class="keyword">self</span>.ai[i]</div><div class="line">            <span class="keyword">self</span>.wi[i][j] = <span class="keyword">self</span>.wi[i][j] + N*change</div></pre></td></tr></table></figure>
<h3 id="训练接口"><a href="#训练接口" class="headerlink" title="训练接口"></a>训练接口</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">trainquery</span><span class="params">(<span class="keyword">self</span>, wordids, urlids, selecturl )</span></span><span class="symbol">:</span></div><div class="line"></div><div class="line">    <span class="keyword">self</span>.generatehiddennode(wordids, urlids)</div><div class="line">    <span class="keyword">self</span>.setupnetwork(wordids, urlids)</div><div class="line">    <span class="keyword">self</span>.feedforward()</div><div class="line"></div><div class="line">    targets = [<span class="number">0</span>.<span class="number">0</span>] * len(urlids)</div><div class="line">    targets[urlids.index(selecturl)]=<span class="number">1</span></div><div class="line">    <span class="keyword">self</span>.backpropagate(targets)</div><div class="line">    <span class="keyword">self</span>.updatedatabase()</div></pre></td></tr></table></figure>
<p>数据库操作</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 更新数据库</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">updatedatabase</span><span class="params">(<span class="keyword">self</span>)</span></span><span class="symbol">:</span></div><div class="line">    <span class="comment"># 将值存入数据库中</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(<span class="keyword">self</span>.wordids))<span class="symbol">:</span></div><div class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">            <span class="keyword">self</span>.setstrength(<span class="keyword">self</span>.wordids[i],<span class="keyword">self</span>.hiddenids[j],<span class="number">0</span>,</div><div class="line">                             <span class="keyword">self</span>.wi[i][j])</div><div class="line"></div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(<span class="keyword">self</span>.hiddenids))<span class="symbol">:</span></div><div class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(len(<span class="keyword">self</span>.urlids))<span class="symbol">:</span></div><div class="line">            <span class="keyword">self</span>.setstrength(<span class="keyword">self</span>.hiddenids[j],<span class="keyword">self</span>.urlids[k],<span class="number">1</span>,</div><div class="line">                             <span class="keyword">self</span>.wo[j][k])</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.con.commit()</div></pre></td></tr></table></figure>
<h3 id="与搜索引擎集成"><a href="#与搜索引擎集成" class="headerlink" title="与搜索引擎集成"></a>与搜索引擎集成</h3><p>在query结束处添加<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">return</span> wordids, [r[<span class="number">1</span>] <span class="keyword">for</span> r <span class="keyword">in</span> rankedscores[<span class="number">0</span>:<span class="number">10</span>]]</div></pre></td></tr></table></figure></p>
<p>在Searchnet 中添加<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 神经网络评价指标</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">nnscore</span><span class="params">(<span class="keyword">self</span>, rows, wordids)</span></span><span class="symbol">:</span></div><div class="line">    <span class="comment"># 获得一个由唯一的URL ID构成的有序列表</span></div><div class="line">    urlids = [urlid <span class="keyword">for</span> urlid <span class="keyword">in</span> set([row[<span class="number">0</span>] <span class="keyword">for</span> row <span class="keyword">in</span> rows])]</div><div class="line">    nnres = mynet.getresult(wordids, urlids)</div><div class="line">    scores = dict([(urlids[i], nnres[i]) <span class="keyword">for</span> i <span class="keyword">in</span> range(len(urlids))])</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.normalizescore(scores)</div></pre></td></tr></table></figure></p>
<h1 id="改进与建议"><a href="#改进与建议" class="headerlink" title="改进与建议"></a>改进与建议</h1><p>这个项目其实仍然是一个非常粗糙的作品，不过其优势在于麻雀虽小，五脏俱全，详细介绍了各种排序算法的基本思想，让我们能了解建立索引的基本步骤。</p>
<p>不足之处</p>
<ol>
<li><strong>支持的数据量</strong>。按照原文的说法，这个项目应该能支撑十万量级的查询。不过在我的实验环境下，我只抓了豆瓣电影top250大概 260个页面，并没有测试在大量数据情况下该项目的运行情况。</li>
<li><strong>神经网络设计</strong>。因为原来该项目是针对英文页面设计的，由于一些语言特性上的不同，换到汉语环境下仍有一些不适应之处。例如在神经网络的<strong>隐含层设计</strong>部分，只考虑了两个单词的组合，并没有考虑更多单词组合的情况。这一部分的设计最重要的是能<strong>让神经网络学习一些词组</strong>，让词组和url关联；还有一个问题则是神经网络的<strong>初始权重和阈值</strong>，应该如何分配，理由是什么。</li>
<li><strong>ignorewords不完善</strong>。这里只例举了“的”,“是”等最常用的无意义的词，除此以外应该还有很多类似的词。</li>
<li><strong>数据库操作异常处理</strong>。如果遇到某些查不到的情况，或者重复建表的情况应处理异常，以提高程序鲁棒性。</li>
<li><strong>汉语分词的困境</strong>。以“团购网站的本质是什么”这句话为例，汉语分词的结果可能是“团购”，“团购网” ，“网站” ，“团购网站”，“本质”，“是”，“什么”;如果在英语语境下，“what is groupon”，分词的结果是显而易见的，“what”,“is”“groupon”。我们在建立索引的时候会记录每个词在每个页面中的位置，这种分词结果的区别可能会影响位置的记录。</li>
<li><strong>删除停词</strong>的部分可以移到separateword里面。</li>
</ol>
<p>其他想改进的地方</p>
<ol>
<li><strong>Web UI</strong>。现在只能在shell里查询结果，需要添加一个Web UI。</li>
<li><strong>引入ORM</strong>。与数据库的连接部分现在都是直接通过拼接字符串构造SQL，并且现阶段是和SQLite捆绑死的。希望能通过引入ORM机制，可以替换数据库层而不修改上层模块。加入对MySQL和MongoDB的支持。  </li>
<li><strong>深入了解分词模块</strong>。这里是直接引用现成的项目，有机会的话想更深入地了解分词的算法。</li>
<li><strong>拼写检查</strong>。这里有两个英文语境下的算法可以参考， Edit(Levenstein) Distance 和 LCS(Longest Common Subsequence)。</li>
<li><strong>同义词转换</strong>。</li>
<li><strong>搜索框支持 and、or 和 not语法</strong>。</li>
<li><strong>基于本体的搜索(语义网)</strong>。说到这一块的话，其实整个搜索引擎的设计理念都改变了。似乎有一些现成的学术上的数据集称为WordNet，另外可以参考一下维基百科的<strong>消除歧义</strong>页面的设计思想(比如同样是苹果这个词，在不同语境下有水果，或者某电子产品品牌的含义)。</li>
</ol>
<h1 id="搜索引擎相关的部分开源项目汇总"><a href="#搜索引擎相关的部分开源项目汇总" class="headerlink" title="搜索引擎相关的部分开源项目汇总"></a>搜索引擎相关的部分开源项目汇总</h1><p>Python Flask-PonyWhoosh 全文搜索<br><a href="https://pypi.python.org/pypi/Flask-PonyWhoosh" target="_blank" rel="external">https://pypi.python.org/pypi/Flask-PonyWhoosh</a></p>
<p>雅虎 Anthelion 页面抓取<br><a href="https://github.com/yahoo/anthelion" target="_blank" rel="external">https://github.com/yahoo/anthelion</a></p>
<p>Apache Lucence<br><a href="https://lucene.apache.org/" target="_blank" rel="external">https://lucene.apache.org/</a></p>
<p>Apache Nutch (基于Lucene)<br><a href="http://nutch.apache.org/" target="_blank" rel="external">http://nutch.apache.org/</a></p>
<p>Apache Solr (基于Lucene)<br><a href="http://lucene.apache.org/solr/" target="_blank" rel="external">http://lucene.apache.org/solr/</a></p>
<p>lucidworks - Spark Search (基于 Lucene, Spark 和 Tachyon)<br><a href="http://www.slideshare.net/lucidworks/spark-search-inmemory-distributed-search-with-lucene-spark-and-tachyon-presented-by-taka-shinagawa-sparksearchorg" target="_blank" rel="external">http://www.slideshare.net/lucidworks/spark-search-inmemory-distributed-search-with-lucene-spark-and-tachyon-presented-by-taka-shinagawa-sparksearchorg</a></p>
<p>Xapian<br><a href="http://xapian.org/" target="_blank" rel="external">http://xapian.org/</a></p>
<p>elasticsearch<br><a href="https://www.elastic.co/products/elasticsearch" target="_blank" rel="external">https://www.elastic.co/products/elasticsearch</a></p>
<p>Sphinx<br><a href="http://sphinxsearch.com/" target="_blank" rel="external">http://sphinxsearch.com/</a></p>
<p>Coreseek - 基于sphinx 专门针对中文分词改进的一个搜索引擎<br><a href="http://www.coreseek.cn/" target="_blank" rel="external">http://www.coreseek.cn/</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>[1] 《集体智慧编程》<br>[2]  &lt; Mordern Information Retrieval &gt; - Ricardo Baeza-Yates<br>[3] <a href="http://book.douban.com/subject/7006719/" target="_blank" rel="external">《这就是搜索引擎》</a><br>[4] <a href="http://book.douban.com/subject/20275942/" target="_blank" rel="external">《精通搜索分析》</a><br>[5] <a href="http://book.douban.com/subject/10546139/" target="_blank" rel="external">《SEO艺术》</a><br>[3] <a href="https://github.com/fxsjy/jieba" target="_blank" rel="external">Jieba分词</a><br>[4] <a href="http://www.zhihu.com/question/19578687" target="_blank" rel="external">有哪些比较好的中文分词方案</a><br>[5] <a href="http://www.oschina.net/news/69035/yahoo-open-sources-anthelion-web-crawler-parsing-structured-data" target="_blank" rel="external">雅虎开源解析 HTML 页面数据的 Web 爬取工具 Anthelion</a><br>[6] <a href="https://github.com/yahoo/anthelion" target="_blank" rel="external">Anthelion - github </a><br>[7] <a href="http://mp.weixin.qq.com/s?__biz=MzA3MDg0MjgxNQ==&amp;mid=400601586&amp;idx=1&amp;sn=78d421c5d91774bb66a8244891c2533d&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd" target="_blank" rel="external">PageRank算法（1）：PageRank算法原理入门</a><br>[8] <a href="http://tech.qq.com/a/20151229/007682.htm" target="_blank" rel="external">Yandex前员工试图出售搜索引擎源代码获刑2年</a><br>[9] <a href="https://segmentfault.com/u/wyh267/articles" target="_blank" rel="external">用golang写一个搜索引擎</a><br>[10] <a href="http://tech.youzan.com/you_zan_searchengine2/" target="_blank" rel="external">有赞搜索引擎实践(算法篇)</a><br>[11] <a href="http://tech.youzan.com/search-engine1/" target="_blank" rel="external">有赞搜索引擎实践(工程篇)</a></p>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/信息检索/"> #信息检索 </a>
          
            <a href="/tags/爬虫/"> #爬虫 </a>
          
            <a href="/tags/python/"> #python </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/12/07/linux-performance-analysis/">【译】Linux系统性能分析的前60000毫秒</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/05/information-security-thought/">意识流的纪录片观后感</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="post-spread">
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      </div>
    

    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="2015/12/06/PySearchEngine/"
               data-title="一个简易搜索引擎(Python)" data-url="http://blkstone.github.io/2015/12/06/PySearchEngine/">
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/avatar.jpg" alt="Ray" />
          <p class="site-author-name">Ray</p>
        </div>
        <p class="site-description motion-element">关于计算机科学的学习经历与精彩文章分享。</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">516</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">149</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/BLKStone" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">Twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">Weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">DouBan</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">ZhiHu</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#总体架构"><span class="nav-number">1.</span> <span class="nav-text">总体架构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Crawler爬虫模块"><span class="nav-number">2.</span> <span class="nav-text">Crawler爬虫模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#类设计"><span class="nav-number">2.1.</span> <span class="nav-text">类设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#控制流程"><span class="nav-number">2.2.</span> <span class="nav-text">控制流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#页面抽取"><span class="nav-number">2.3.</span> <span class="nav-text">页面抽取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立索引"><span class="nav-number">2.4.</span> <span class="nav-text">建立索引</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URL过滤"><span class="nav-number">2.5.</span> <span class="nav-text">URL过滤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#运行"><span class="nav-number">2.6.</span> <span class="nav-text">运行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Searcher搜索模块"><span class="nav-number">3.</span> <span class="nav-text">Searcher搜索模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#类设计-1"><span class="nav-number">3.1.</span> <span class="nav-text">类设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询相关URL"><span class="nav-number">3.2.</span> <span class="nav-text">查询相关URL</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#查询接口"><span class="nav-number">3.3.</span> <span class="nav-text">查询接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#多指标排序"><span class="nav-number">3.4.</span> <span class="nav-text">多指标排序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#归一化函数"><span class="nav-number">3.5.</span> <span class="nav-text">归一化函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于内容的排名"><span class="nav-number">3.6.</span> <span class="nav-text">基于内容的排名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#利用外部回指链接"><span class="nav-number">3.7.</span> <span class="nav-text">利用外部回指链接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简单计数"><span class="nav-number">3.7.1.</span> <span class="nav-text">简单计数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PageRank"><span class="nav-number">3.7.2.</span> <span class="nav-text">PageRank</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#利用链接文本"><span class="nav-number">3.7.3.</span> <span class="nav-text">利用链接文本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#跟踪点击的人工神经网络设计"><span class="nav-number">3.8.</span> <span class="nav-text">跟踪点击的人工神经网络设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#类设计-2"><span class="nav-number">3.8.1.</span> <span class="nav-text">类设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库设计"><span class="nav-number">3.8.2.</span> <span class="nav-text">数据库设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#辅助函数"><span class="nav-number">3.8.3.</span> <span class="nav-text">辅助函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#建立新的隐含层节点"><span class="nav-number">3.8.4.</span> <span class="nav-text">建立新的隐含层节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询相关隐层节点"><span class="nav-number">3.8.5.</span> <span class="nav-text">查询相关隐层节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置网络初始权值"><span class="nav-number">3.8.6.</span> <span class="nav-text">设置网络初始权值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前向传播"><span class="nav-number">3.8.7.</span> <span class="nav-text">前向传播</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反向传播-backpropagate-训练"><span class="nav-number">3.8.8.</span> <span class="nav-text">反向传播(backpropagate)训练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#训练接口"><span class="nav-number">3.8.9.</span> <span class="nav-text">训练接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#与搜索引擎集成"><span class="nav-number">3.8.10.</span> <span class="nav-text">与搜索引擎集成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#改进与建议"><span class="nav-number">4.</span> <span class="nav-text">改进与建议</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#搜索引擎相关的部分开源项目汇总"><span class="nav-number">5.</span> <span class="nav-text">搜索引擎相关的部分开源项目汇总</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">6.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2015 - 
  2017
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Ray</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.3" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blkstone"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  

</body>
</html>
